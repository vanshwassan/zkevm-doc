
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.hermez.io/zkEVM/Basic-Concepts/A-Generic-State-Machine/">
      
      <link rel="icon" href="../../../favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>A Generic State Machine - Polygon zkEVM Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.472b142f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.08040f6c.min.css">
        
          
          
          <meta name="theme-color" content="#7e56c2">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#generic-state-machine-executor" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Polygon zkEVM Documentation" class="md-header__button md-logo" aria-label="Polygon zkEVM Documentation" data-md-component="logo">
      
  <img src="../../../logo-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Polygon zkEVM Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              A Generic State Machine
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hermeznetwork/zkevmdoc" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../Overview/Overview/" class="md-tabs__link md-tabs__link--active">
        Polygon zkEVM
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../Hermez_1.0/about/scalability/" class="md-tabs__link">
        Hermez 1.0
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Polygon zkEVM Documentation" class="md-nav__button md-logo" aria-label="Polygon zkEVM Documentation" data-md-component="logo">
      
  <img src="../../../logo-white.svg" alt="logo">

    </a>
    Polygon zkEVM Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hermeznetwork/zkevmdoc" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Polygon zkEVM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Polygon zkEVM" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Polygon zkEVM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Overview/Overview/" class="md-nav__link">
        zkEVM Overview
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_2" type="checkbox" id="__nav_1_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_1_2">
          Basic Concepts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Basic Concepts" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_2">
          <span class="md-nav__icon md-icon"></span>
          Basic Concepts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Intro-zkProver%27s-Design-Approach/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mFibonnaci-State-Machine-eg/" class="md-nav__link">
        Multiplicative Fibonacci SM
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          A Generic State Machine
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        A Generic State Machine
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#generic-state-machine-executor" class="md-nav__link">
    Generic State Machine Executor
  </a>
  
    <nav class="md-nav" aria-label="Generic State Machine Executor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#an-example-of-state-machine-instructions" class="md-nav__link">
    An Example of State Machine Instructions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-trace-example-continued" class="md-nav__link">
    Execution Trace (Example continued)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assuring-correctness-of-the-execution-trace" class="md-nav__link">
    Assuring Correctness Of The Execution Trace
  </a>
  
    <nav class="md-nav" aria-label="Assuring Correctness Of The Execution Trace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-arithmetic-constraints" class="md-nav__link">
    Creating The Arithmetic Constraints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-arithmetic-constraints-against-instructions" class="md-nav__link">
    Testing Arithmetic Constraints Against Instructions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-deeper-context-for-the-executor" class="md-nav__link">
    A Deeper Context For The Executor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#polynomial-identities" class="md-nav__link">
    Polynomial Identities
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dealing-with-negative-numbers" class="md-nav__link">
    Dealing With Negative Numbers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-conditional-jumps" class="md-nav__link">
    Using Conditional Jumps
  </a>
  
    <nav class="md-nav" aria-label="Using Conditional Jumps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#naive-way-to-end-the-program" class="md-nav__link">
    Naïve Way To End The Program
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conditional-jumps-examples" class="md-nav__link">
    Conditional Jumps Examples
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#programs-with-conditional-jumps" class="md-nav__link">
    Programs With Conditional Jumps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correctness-checks-for-state-machines-with-jumps" class="md-nav__link">
    Correctness Checks For State Machines With Jumps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-sequence-of-instructions" class="md-nav__link">
    Checking Sequence Of Instructions
  </a>
  
    <nav class="md-nav" aria-label="Checking Sequence Of Instructions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-program-counter-constraint-related-to-textttjmp" class="md-nav__link">
    The Program Counter Constraint Related To \(\texttt{JMP}\)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-program-counter-constraint-related-to-textttjmpz" class="md-nav__link">
    The Program Counter Constraint Related To \(\texttt{JMPZ}\)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-program-counter-constraint-related-to-textttjmp-and-textttjmpz" class="md-nav__link">
    The Program Counter Constraint Related To \(\texttt{JMP}\) And \(\texttt{JMPZ}\)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correct-program-ending-with-a-loop" class="md-nav__link">
    Correct Program Ending With A Loop
  </a>
  
    <nav class="md-nav" aria-label="Correct Program Ending With A Loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-by-step-commentary-on-the-execution-trace" class="md-nav__link">
    Step-by-step Commentary On The Execution Trace
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#publics-placed-at-known-steps" class="md-nav__link">
    Publics Placed at Known Steps
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_3" type="checkbox" id="__nav_1_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_3">
          zkProver
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="zkProver" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_3">
          <span class="md-nav__icon md-icon"></span>
          zkProver
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zkProver/Overview/zkProver-Overview/" class="md-nav__link">
        zkProver Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_3_2" type="checkbox" id="__nav_1_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_3_2">
          States Machines
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="States Machines" data-md-level="3">
        <label class="md-nav__title" for="__nav_1_3_2">
          <span class="md-nav__icon md-icon"></span>
          States Machines
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zkProver/State-Machines/Overview/zkProver-State-Machines/" class="md-nav__link">
        State Machines Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_3_2_2" type="checkbox" id="__nav_1_3_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_3_2_2">
          Secondary State Machines
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Secondary State Machines" data-md-level="4">
        <label class="md-nav__title" for="__nav_1_3_2_2">
          <span class="md-nav__icon md-icon"></span>
          Secondary State Machines
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zkProver/State-Machines/Secondary-State-Machines/Arithmetic/Arithmetic/" class="md-nav__link">
        Arithmetic
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zkProver/State-Machines/Secondary-State-Machines/Storage/Storage/" class="md-nav__link">
        Storage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zkProver/State-Machines/Secondary-State-Machines/Hashing/Introduction/" class="md-nav__link">
        Hashing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zkProver/State-Machines/Secondary-State-Machines/Binary/Binary/" class="md-nav__link">
        Binary
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zkProver/State-Machines/Secondary-State-Machines/Memory/Memory/" class="md-nav__link">
        Memory
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zkProver/State-Machines/Secondary-State-Machines/Memory-Align/Memory-Align/" class="md-nav__link">
        Memory Align
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zkProver/State-Machines/Secondary-State-Machines/Complementary/Complementary/" class="md-nav__link">
        Complementary
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zkProver/State-Machines/Secondary-State-Machines/Complementary/Configuration-File/" class="md-nav__link">
        Configuration File
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_4" type="checkbox" id="__nav_1_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_4">
          zk Tooling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="zk Tooling" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_4">
          <span class="md-nav__icon md-icon"></span>
          zk Tooling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_4_1" type="checkbox" id="__nav_1_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_4_1">
          zkASM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="zkASM" data-md-level="3">
        <label class="md-nav__title" for="__nav_1_4_1">
          <span class="md-nav__icon md-icon"></span>
          zkASM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zk-Tooling/zkASM/Introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zk-Tooling/zkASM/Basic-Syntax/" class="md-nav__link">
        Basic Syntax
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zk-Tooling/zkASM/Some-Examples/" class="md-nav__link">
        Some Examples
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zk-Tooling/zkASM/Related-Repos/" class="md-nav__link">
        Related Repositories
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_4_2" type="checkbox" id="__nav_1_4_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_4_2">
          PIL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="PIL" data-md-level="3">
        <label class="md-nav__title" for="__nav_1_4_2">
          <span class="md-nav__icon md-icon"></span>
          PIL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zk-Tooling/PIL/Introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zk-Tooling/PIL/Hello-World-Examples/" class="md-nav__link">
        Hello Word Examples
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zk-Tooling/PIL/Components/" class="md-nav__link">
        Components
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zk-Tooling/PIL/Cyclical-Nature/" class="md-nav__link">
        Cyclical Nature
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zk-Tooling/PIL/Modularity/" class="md-nav__link">
        Modularity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zk-Tooling/PIL/Advanced-Features/" class="md-nav__link">
        Advanced Features
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zk-Tooling/PIL/Related-Repos/" class="md-nav__link">
        Related Repositories
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../references/" class="md-nav__link">
        References
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Hermez 1.0
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Hermez 1.0" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Hermez 1.0
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          About
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="About" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/about/scalability/" class="md-nav__link">
        Ethereum Scalability and zk-Rollups
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/about/value-proposition/" class="md-nav__link">
        Hermez Value Proposition
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/about/model/" class="md-nav__link">
        Hermez Network Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/about/security/" class="md-nav__link">
        Security
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          Users
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Users" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Users
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/users/hermez-wallet/" class="md-nav__link">
        Hermez Wallet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/users/mainnet/" class="md-nav__link">
        Hermez Mainnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/users/testnet/" class="md-nav__link">
        Hermez Testnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/users/exchanges/" class="md-nav__link">
        Exchanges
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          Developers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Developers" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Developers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/developers/dev-guide/" class="md-nav__link">
        Developer Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_2" type="checkbox" id="__nav_2_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3_2">
          Protocol
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Protocol" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_3_2">
          <span class="md-nav__icon md-icon"></span>
          Protocol
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_2_1" type="checkbox" id="__nav_2_3_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3_2_1">
          Hermez zkRollup protocol
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Hermez zkRollup protocol" data-md-level="4">
        <label class="md-nav__title" for="__nav_2_3_2_1">
          <span class="md-nav__icon md-icon"></span>
          Hermez zkRollup protocol
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/developers/protocol/hermez-protocol/protocol/" class="md-nav__link">
        Core protocol
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/developers/protocol/hermez-protocol/contracts/contracts/" class="md-nav__link">
        Smart contracts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/developers/protocol/hermez-protocol/circuits/circuits/" class="md-nav__link">
        Circuits
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/developers/protocol/consensus/consensus/" class="md-nav__link">
        Forging consensus protocol
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/developers/protocol/withdrawal-delayer/withdrawal-delayer/" class="md-nav__link">
        Withdrawal delayer protocol
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/developers/sdk/" class="md-nav__link">
        Examples/SDK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/developers/api/" class="md-nav__link">
        API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/developers/batch-explorer/" class="md-nav__link">
        Batch Explorer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/developers/price-updater/" class="md-nav__link">
        Hermez NodePrice Updater
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/developers/glossary/" class="md-nav__link">
        Glossary
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_4">
          FAQ
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="FAQ" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          FAQ
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/faq/end-users/" class="md-nav__link">
        End-Users
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/faq/integrators/" class="md-nav__link">
        Integrators
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/faq/coordinators/" class="md-nav__link">
        Coordinators
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/faq/pod/" class="md-nav__link">
        Proof of Donation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Hermez_1.0/faq/other/" class="md-nav__link">
        Other
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#generic-state-machine-executor" class="md-nav__link">
    Generic State Machine Executor
  </a>
  
    <nav class="md-nav" aria-label="Generic State Machine Executor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#an-example-of-state-machine-instructions" class="md-nav__link">
    An Example of State Machine Instructions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-trace-example-continued" class="md-nav__link">
    Execution Trace (Example continued)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assuring-correctness-of-the-execution-trace" class="md-nav__link">
    Assuring Correctness Of The Execution Trace
  </a>
  
    <nav class="md-nav" aria-label="Assuring Correctness Of The Execution Trace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-arithmetic-constraints" class="md-nav__link">
    Creating The Arithmetic Constraints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-arithmetic-constraints-against-instructions" class="md-nav__link">
    Testing Arithmetic Constraints Against Instructions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-deeper-context-for-the-executor" class="md-nav__link">
    A Deeper Context For The Executor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#polynomial-identities" class="md-nav__link">
    Polynomial Identities
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dealing-with-negative-numbers" class="md-nav__link">
    Dealing With Negative Numbers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-conditional-jumps" class="md-nav__link">
    Using Conditional Jumps
  </a>
  
    <nav class="md-nav" aria-label="Using Conditional Jumps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#naive-way-to-end-the-program" class="md-nav__link">
    Naïve Way To End The Program
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conditional-jumps-examples" class="md-nav__link">
    Conditional Jumps Examples
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#programs-with-conditional-jumps" class="md-nav__link">
    Programs With Conditional Jumps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correctness-checks-for-state-machines-with-jumps" class="md-nav__link">
    Correctness Checks For State Machines With Jumps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-sequence-of-instructions" class="md-nav__link">
    Checking Sequence Of Instructions
  </a>
  
    <nav class="md-nav" aria-label="Checking Sequence Of Instructions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-program-counter-constraint-related-to-textttjmp" class="md-nav__link">
    The Program Counter Constraint Related To \(\texttt{JMP}\)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-program-counter-constraint-related-to-textttjmpz" class="md-nav__link">
    The Program Counter Constraint Related To \(\texttt{JMPZ}\)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-program-counter-constraint-related-to-textttjmp-and-textttjmpz" class="md-nav__link">
    The Program Counter Constraint Related To \(\texttt{JMP}\) And \(\texttt{JMPZ}\)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correct-program-ending-with-a-loop" class="md-nav__link">
    Correct Program Ending With A Loop
  </a>
  
    <nav class="md-nav" aria-label="Correct Program Ending With A Loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-by-step-commentary-on-the-execution-trace" class="md-nav__link">
    Step-by-step Commentary On The Execution Trace
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#publics-placed-at-known-steps" class="md-nav__link">
    Publics Placed at Known Steps
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/hermeznetwork/zkevmdoc/edit/master/docs/zkEVM/Basic-Concepts/A-Generic-State-Machine.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


  <h1>A Generic State Machine</h1>

<p>Unlike the mFibonacci state machine, which is an implementation of one specific computation, we now describe a generic state machine that can be instantiated with various computations of the user's choice.</p>
<p>The idea here is to create a state machine that behaves like a processor of sorts. In as much as a processor has registries and a clock, so is our generic state machine. It receives instructions in the form of programs written in Assembly, and makes state transitions at each clock in accordance with these instructions.</p>
<p>See Figure below, for such a state machine, with registries <span class="arithmatex">\(\texttt{A}\)</span> and <span class="arithmatex">\(\texttt{B}\)</span>, and a state <span class="arithmatex">\(\big(\texttt{A}^{\texttt{i}},\texttt{B}^{\texttt{i}}\big)\)</span> that changes to another state <span class="arithmatex">\(\big(\texttt{A}^{\texttt{i+2}},\texttt{B}^{\texttt{i+2}}\big)\)</span> in accordance with two instructions, <span class="arithmatex">\(\texttt{Instruction}_{\texttt{i}}\)</span> and <span class="arithmatex">\(\texttt{Instruction}_{\texttt{i+1}}\)</span>.</p>
<p><img alt="Figure 1: A typical generic state machine" src="../figures/typical-gen-sm.png" /></p>
<div align="center"><b> Figure 1: A typical generic state machine </b></div>

<p>The aim with this document is to explain how the machinery used in the mFibonacci SM; to execute computations, produce proofs of correctness of execution, and verify these proofs; can extend to a generic state machine.</p>
<p>Think of our state machine as being composed of two parts; the part that has to do with generating the execution trace, while the other part is focused on verifying that the executions were correctly executed. </p>
<ul>
<li>The former part is more like the "software" of the state machine, as it is concerned with interpreting program instructions and correctly generating the execution trace. A novel language dubbed the <strong>Zero-knowledge Assembly Language</strong> (zkASM) is used in this part.</li>
<li>But the latter part is more like the "hardware" as it consists of a set of arithmetic constraints (or their equivalent, polynomial identities) that every correctly generated execution trace must satisfy. Since these arithmetic constraints are transformed into polynomial identities (via an interpolation process), they are described in a novel language called the <strong>Polynomial Identity Language</strong> (PIL).</li>
</ul>
<h2 id="generic-state-machine-executor">Generic State Machine Executor</h2>
<p>As seen with the mFibonacci SM, the SM executor takes certain inputs together with the description of the SM, in order to produce the execution trace specifically corresponding to these inputs. </p>
<p><img alt="Figure 2: mFibonacci State Machine producing input-specific execution trace" src="../figures/mfib-exec-w-inputs.png" /></p>
<div align="center"><b> Figure 2: mFibonacci State Machine producing input-specific execution trace </b></div>

<p>The main difference in the Generic State Machine case, is the inclusion of a program which stipulates computations to be carried out by the SM executor. These computations could range from a simple addition of two registry values, or moving the value in registry <span class="arithmatex">\(\texttt{A}\)</span> to registry <span class="arithmatex">\(\texttt{B}\)</span>, to computing some linear combination of several registry values.</p>
<p><img alt="Figure 3: A Generic State Machine producing input- and program-specific execution trace " src="../figures/gen-sm-w-input-instrctn.png" /></p>
<div align="center"><b> Figure 3: A Generic State Machine producing input- and program-specific execution trace  </b></div>

<p>So then, instead of programming the SM executor ourselves with a specific set of instructions as we did with the mFibonacci SM, the Generic SM executor is programmed to read arbitrary instructions encapsulated in some program (depending on the capacity of the SM or the SM's context of application). As mentioned above, each of these programs is initially written, not in a language like Javascript, but in the zkASM language.</p>
<h3 id="an-example-of-state-machine-instructions">An Example of State Machine Instructions</h3>
<p>We continue with the state machine model shown in Figure 1 above; a state machine with two registries <span class="arithmatex">\(\texttt{A}\)</span> and <span class="arithmatex">\(\texttt{B}\)</span>, which executes computations as per instruction(s) specified in a program.</p>
<p>Here is an example of a program containing four (4) instructions, expressed in zkASM,</p>
<div align="center"><b> Table 1: A Program with four instructions in Assembly Code   </b></div>

<div class="arithmatex">\[
\begin{aligned}
\begin{array}{|l|c|}
\hline 
\bf{Instructions } \text{ }\text{ }\text{ }\text{ } \\ \hline
\mathtt{\$\{getAFreeInput()\} =&gt; A} \text{ }\\ \hline
\mathtt{3 =&gt; B} \qquad\qquad\qquad\qquad\quad \\ \hline
\mathtt{:ADD } \qquad\qquad\qquad\quad\quad\quad\text{ }\text{ } \\ \hline
\mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ } \\ \hline 
\end{array}
\end{aligned}
\]</div>
<p>Suppose the state machine starts with the initial state <span class="arithmatex">\(\big(\texttt{A},\texttt{B}\big) = \big(\texttt{0},\texttt{0} \big)\)</span>. The SM executor sequentially executes each instruction as follows;  </p>
<ul>
<li>Firstly, "<span class="arithmatex">\(\mathtt{\$\{getAFreeInput()\} =&gt; A}\)</span>" is a request to execute the function <span class="arithmatex">\(\texttt{getAFreeInput()}\)</span>. That is, the executor must get a free input value and move it into register <span class="arithmatex">\(\texttt{A}\)</span>. Note that "free input" simply means the input can be any value.</li>
<li>Secondly, "<span class="arithmatex">\(\mathtt{3 =&gt; B}\)</span>" means the executor must move the constant value <span class="arithmatex">\(\mathtt{3}\)</span> into register <span class="arithmatex">\(\mathtt{B}\)</span>. Since the value <span class="arithmatex">\(\texttt{3}\)</span> is part of an instruction, it is referred to as the <em>constant of the execution</em>. Also, it is called a constant because, for a given program, it cannot be freely chosen.</li>
<li>Thirdly, "<span class="arithmatex">\(\mathtt{:ADD }\)</span>" instructs the executor to compute the sum of registry values in <span class="arithmatex">\(\mathtt{A}\)</span> and <span class="arithmatex">\(\mathtt{B}\)</span>, and save the output into register <span class="arithmatex">\(\mathtt{A}\)</span>.</li>
<li>Lastly, "<span class="arithmatex">\(\mathtt{:END }\)</span>" tells the executor to reset the registers <span class="arithmatex">\(\mathtt{A}\)</span> and <span class="arithmatex">\(\mathtt{B}\)</span> to their initial values in the next state, and thus achieving the cyclic behaviour.</li>
</ul>
<h3 id="execution-trace-example-continued">Execution Trace (Example continued)</h3>
<p>In addition to carrying out computations as per instructions in programs, the executor must also generate an execution trace of all state transitions, called the Execution Trace.</p>
<p>Consider, as an example, the execution trace the executor produces for the above program of four instructions. Suppose the free input value used is <span class="arithmatex">\(7\)</span>. The generated execution trace can be depicted in tabular form as shown below.</p>
<div align="center"><b> Table 2: Execution Trace of the SM as per four instructions  </b></div>

<div class="arithmatex">\[
\begin{aligned}\begin{array}{|l|c|c|c|c|c|c|c|}\hline 
\bf{Instructions } \text{ }\text{ }\text{ }\text{ } &amp; \texttt{FREE} &amp; \texttt{CONST}&amp; \texttt{A}&amp; \mathtt{A'}&amp; \texttt{B}&amp; \mathtt{B'} \\ \hline 
\mathtt{\$\{getAFreeInput()\} =&gt; A} \text{ } &amp; \texttt{7} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{7} &amp; \texttt{0} &amp; \texttt{0}\\ \hline
\mathtt{3 =&gt; B} \qquad\qquad\qquad\qquad\quad &amp; \texttt{0} &amp; \texttt{3} &amp; \texttt{7} &amp; \texttt{7} &amp; \texttt{0} &amp; \texttt{3} \\ \hline
\mathtt{:ADD } \qquad\qquad\qquad\quad\quad\quad\text{ }\text{ } &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{7} &amp; \texttt{10} &amp; \texttt{3} &amp; \texttt{3} \\ \hline
\mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ } &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{10} &amp; \texttt{0} &amp; \texttt{3} &amp; \texttt{0} \\ \hline
\end{array}
\end{aligned}
\]</div>
<p>This execution trace utilises a total of six (6) columns. Perhaps the use of the columns corresponding to the two registries <span class="arithmatex">\(\texttt{A}\)</span> and <span class="arithmatex">\(\texttt{B}\)</span>, as well as the columns for the constant <span class="arithmatex">\(\texttt{CONST}\)</span> and the free input <span class="arithmatex">\(\texttt{FREE}\)</span>, are a bit obvious. But the reason for having the other two columns, <span class="arithmatex">\(\mathtt{A'}\)</span> and <span class="arithmatex">\(\mathtt{B'}\)</span>, may not be so apparent. </p>
<p>The reason there are two extra columns, instead of only four, is the need to capture each state transition in full, and per instruction. The column labelled <span class="arithmatex">\(\mathtt{A'}\)</span> therefore denotes the next state of the registry <span class="arithmatex">\(\mathtt{A}\)</span>, and similarly, <span class="arithmatex">\(\mathtt{B'}\)</span> denotes the next state of the registry <span class="arithmatex">\(\mathtt{B}\)</span>. This ensures that each row of the execution trace reflects the entire state transition pertaining to each specific instruction.</p>
<p>The execution trace is therefore read <em>row-by-row</em> as follows,</p>
<ul>
<li>The first row, which is per instruction "<span class="arithmatex">\(\mathtt{\$\{getAFreeInput()\} =&gt; A}\)</span>", reads thus: The function <span class="arithmatex">\(\texttt{getAFreeInput()}\)</span> was executed, by getting the free input value of <span class="arithmatex">\(7\)</span>, which is to be moved into the registry <span class="arithmatex">\(\texttt{A}\)</span> as the next registry value.</li>
<li>The second row, which is per instruction "<span class="arithmatex">\(\mathtt{3 =&gt; B}\)</span>", reads as follows: A constant value <span class="arithmatex">\(\texttt{3}\)</span> is to be moved into the registry <span class="arithmatex">\(\texttt{B}\)</span> as the next registry value, and the registry <span class="arithmatex">\(\texttt{A}\)</span> now reflects the value <span class="arithmatex">\(\texttt{7}\)</span> as expected per previous instruction.</li>
<li>The third row, which is per instruction "<span class="arithmatex">\(\mathtt{:ADD }\)</span>", indicates that: The executor executed the sum of registry values in <span class="arithmatex">\(\mathtt{A}\)</span> and <span class="arithmatex">\(\mathtt{B}\)</span> <span class="arithmatex">\(\big( \text{i.e.},\ \mathtt{7 + 3 = 10}\big)\)</span> and the output <span class="arithmatex">\(\mathtt{10}\)</span> is to be moved into register <span class="arithmatex">\(\mathtt{A}\)</span>, as <span class="arithmatex">\(\mathtt{A}\)</span>'s next registry value.</li>
<li>The last row, which is per instruction "<span class="arithmatex">\(\mathtt{:END }\)</span>", tells us that: The executor has updated the registry value in <span class="arithmatex">\(\mathtt{A}\)</span> according to the previous instruction, and will reset the registries <span class="arithmatex">\(\mathtt{A}\)</span> and <span class="arithmatex">\(\mathtt{B}\)</span> to zeros (their initial values) as their next registry values.</li>
</ul>
<p>Note that, for this specific program, a change in the free input from <span class="arithmatex">\(7\)</span> to another number would obviously yield a different execution trace, yet without violating the first instruction.</p>
<h2 id="assuring-correctness-of-the-execution-trace">Assuring Correctness Of The Execution Trace</h2>
<p>Next, we build a mechanism for verifying correctness of the execution trace. This requires creating a set of arithmetic constraints that only hold true when the execution trace is correct. These arithmetic constraints are equations that registry values in any two consecutive rows of the correct execution trace, must satisfy.</p>
<p>Similar to the mFibonacci SM, where each state had to conform to polynomial identities, the arithmetic constraints of the generic state machine will be translated into polynomial identities and ultimately be expressed in PIL.</p>
<h3 id="creating-the-arithmetic-constraints">Creating The Arithmetic Constraints</h3>
<p>Since these arithmetic constraints govern state transitions, they express the next state <span class="arithmatex">\(\big(\mathtt{A'} ,\mathtt{B'}\big)\)</span> in terms of current state <span class="arithmatex">\(\big(\texttt{A},\texttt{B}\big)\)</span>. That is, in terms of the execution trace, the new registry values are linear combinations of previous registry values, together with constants and free inputs.</p>
<p>We therefore need auxiliary columns called <strong>selectors</strong>. Like switches that can either be ON or OFF, selectors too can either have a value <span class="arithmatex">\(\mathtt{1}\)</span> or <span class="arithmatex">\(\mathtt{0}\)</span>, depending on the instruction being executed.</p>
<p>In continuing with our example of a four-instruction state machine, </p>
<ul>
<li>
<p>We use selectors; <span class="arithmatex">\(\texttt{inFREE}\)</span>, <span class="arithmatex">\(\texttt{inA}\)</span>, <span class="arithmatex">\(\texttt{inB}\)</span>, <span class="arithmatex">\(\texttt{setA}\)</span> and <span class="arithmatex">\(\texttt{setB}\)</span>; corresponding to the columns; <span class="arithmatex">\(\texttt{FREE}\)</span>, <span class="arithmatex">\(\texttt{A}\)</span>, <span class="arithmatex">\(\texttt{B}\)</span>, <span class="arithmatex">\(\mathtt{A'}\)</span> and <span class="arithmatex">\(\mathtt{B'}\)</span>, respectively.</p>
</li>
<li>
<p>If the instruction being executed involves a column <span class="arithmatex">\(\texttt{X}\)</span>, then the corresponding selector <span class="arithmatex">\(\texttt{inX}\)</span> must have the value <span class="arithmatex">\(\mathtt{1}\)</span>, otherwise <span class="arithmatex">\(\texttt{inX}\)</span> must be <span class="arithmatex">\(\mathtt{0}\)</span>.</p>
</li>
<li>If the instruction being executed moves the result of the computation into column <span class="arithmatex">\(\mathtt{X'}\)</span>, then the corresponding selector <span class="arithmatex">\(\texttt{setX}\)</span> must have the value <span class="arithmatex">\(\mathtt{1}\)</span>, otherwise <span class="arithmatex">\(\texttt{setX}\)</span> must be <span class="arithmatex">\(\mathtt{0}\)</span>.</li>
<li>Notice that <span class="arithmatex">\(\texttt{CONST}\)</span> does not need a selector. If a computation constant is not needed in an instruction, the corresponding value in the <span class="arithmatex">\(\texttt{CONST}\)</span> column is simply set to <span class="arithmatex">\(\texttt{0}\)</span>.</li>
</ul>
<p>The <strong>arithmetic constraints</strong> are therefore defined by the following linear combinations;</p>
<div class="arithmatex">\[
\mathtt{A′ = A + setA \cdot \big( inA \cdot A + inB \cdot B + inFREE \cdot FREE + CONST - A \big)}\\ \tag{Eqn 1(a)}
\]</div>
<div class="arithmatex">\[
\mathtt{B′ = B + setB \cdot \big( inA \cdot A + inB \cdot B + inFREE \cdot FREE + CONST - B \big)} \\ \tag{Eqn 1(b)}
\]</div>
<p>The figure below, depicts the linear combinations of the our state machine as an algebraic processor of sorts.</p>
<p><img alt="Figure 4: The Generic State Machine as an Algebraic Processor" src="../figures/gen-sm-alg-processor.png" /></p>
<div align="center"><b> Figure 4: The Generic State Machine as an Algebraic Processor </b></div>

<p>The vertical gray box (with the "+" sign) in the above figure, denotes addition. It expresses forming linear combinations of some of the columns; <span class="arithmatex">\(\texttt{FREE}\)</span>, <span class="arithmatex">\(\texttt{A}\)</span>, <span class="arithmatex">\(\texttt{B}\)</span>, or <span class="arithmatex">\(\texttt{CONST}\)</span>. Each is either included or excluded from the linear combination depending on whether their corresponding selectors have the value <span class="arithmatex">\(\mathtt{1}\)</span> or <span class="arithmatex">\(\mathtt{0}\)</span>. </p>
<p>See next subsection for an illustration of how this processor enables testing the constraints.</p>
<h3 id="testing-arithmetic-constraints-against-instructions">Testing Arithmetic Constraints Against Instructions</h3>
<p>We now test if the arithmetic constraints tally with each of the four instructions of our program.</p>
<p>(a) The first instruction: "<span class="arithmatex">\(\mathtt{\$\{getAFreeInput()\} =&gt; A}\)</span>".</p>
<p>The first instruction involves a free input <span class="arithmatex">\(7\)</span> and this free input is moved into registry <span class="arithmatex">\(\texttt{A}\)</span>, as its the next value. Therefore, by definition of the selectors, <span class="arithmatex">\(\mathtt{inFREE = 1}\)</span> and <span class="arithmatex">\(\mathtt{setA = 1}\)</span>. Also, the value of the other selectors is <span class="arithmatex">\(\texttt{0}\)</span>. Substituting these values in the above arithmetic constraints yields;
$$
\mathtt{A′ = A + 1 \cdot \big( 0 \cdot A + 0 \cdot B + 1 \cdot 7 + 0 - A \big) = A + (7 - A) = 7}\text{}
$$</p>
<p>$$
\mathtt{B′ = B + 0 \cdot \big( 0 \cdot A + 0 \cdot B + 1 \cdot 7 + 0 - B \big) = B}\qquad\qquad\quad \
$$
This illustrates that the value of the free input was moved into <span class="arithmatex">\(\texttt{A}\)</span>, while <span class="arithmatex">\(\texttt{B}\)</span> remains unaltered. Hence, the first instruction was correctly executed.</p>
<p>(b) The second instruction: "<span class="arithmatex">\(\mathtt{3 =&gt; B}\)</span>".</p>
<p>The second instruction involves the <span class="arithmatex">\(\mathtt{CONST}\)</span> column, and the constant value <span class="arithmatex">\(\texttt{3}\)</span> is moved into registry <span class="arithmatex">\(\texttt{B}\)</span>, as its next value. Consequently, <span class="arithmatex">\(\mathtt{CONST = 3}\)</span> and <span class="arithmatex">\(\mathtt{setB = 1}\)</span>. All other selectors have the value <span class="arithmatex">\(\texttt{0}\)</span>. Again, substituting these values in the arithmetic constraints yields;
$$
\mathtt{A′ = A + 0 \cdot \big( 0 \cdot A + 0 \cdot B + 0 \cdot FREE + 3 - A \big) = A}\qquad\qquad\qquad \
$$</p>
<p>$$
\mathtt{B′ = B + 1 \cdot \big( 0 \cdot A + 0 \cdot B + 0 \cdot FREE + 3 - B \big) = B + (3 - B) = 3} \
$$
This shows that the value of <span class="arithmatex">\(\texttt{A}\)</span> was not changed, but the constant value <span class="arithmatex">\(\mathtt{3}\)</span>  was moved into <span class="arithmatex">\(\texttt{B}\)</span>. And thus, the second instruction was correctly executed.</p>
<p>(c) The third instruction, "<span class="arithmatex">\(\mathtt{:ADD }\)</span>".</p>
<p>This instruction involves the registries <span class="arithmatex">\(\texttt{A}\)</span> and <span class="arithmatex">\(\texttt{B}\)</span>, and the result is moved into registry <span class="arithmatex">\(\texttt{A}\)</span>, as its the next value. This means, the values of the corresponding selectors are as follows; <span class="arithmatex">\(\mathtt{inA = 1}\)</span>, <span class="arithmatex">\(\mathtt{inB = 1}\)</span> and <span class="arithmatex">\(\mathtt{setA = 1}\)</span>. The arithmetic constraints become;
$$
\mathtt{A′ = A + 1 \cdot \big( 1 \cdot A + 1 \cdot B + 0 \cdot FREE + 0 - A \big) = A + (A + B - A) = A + B}\text{ } \
$$</p>
<p>$$
\mathtt{B′ = B + 0 \cdot \big( 1 \cdot A + 1 \cdot B + 0 \cdot FREE + 0 - B \big) = B}\qquad\qquad\qquad\qquad\quad  \
$$
The sum of the registry values in <span class="arithmatex">\(\mathtt{A}\)</span> and <span class="arithmatex">\(\mathtt{B}\)</span> was moved into <span class="arithmatex">\(\texttt{A}\)</span>, while <span class="arithmatex">\(\texttt{B}\)</span> remains unmodified, proving that the third instruction was correctly executed.</p>
<p>(d) The fourth instruction, "<span class="arithmatex">\(\mathtt{:END }\)</span>".</p>
<p>The fourth instruction moves the initial registry values (i.e., <span class="arithmatex">\(\mathtt{A = 0}\)</span> and <span class="arithmatex">\(\mathtt{B_0 = 0}\)</span>) into registries <span class="arithmatex">\(\texttt{A}\)</span> and <span class="arithmatex">\(\texttt{B}\)</span>, as their next values, respectively. As a result, values of the corresponding selectors are; <span class="arithmatex">\(\mathtt{setA = 1}\)</span> and <span class="arithmatex">\(\mathtt{setB = 1}\)</span>. Substitutions into the arithmetic constraints give us the following;
$$
\mathtt{A′ = A + 1 \cdot \big( 0 \cdot A + 0 \cdot B + 0 \cdot FREE + 0 - A \big) = A - A = 0} \
$$</p>
<p>$$
\mathtt{B′ = B + 1 \cdot \big( 0 \cdot A + 0 \cdot B + 0 \cdot FREE + 0 - B \big) = B - B = 0} \
$$
Clearly, the next registry values of both <span class="arithmatex">\(\mathtt{A}\)</span> and <span class="arithmatex">\(\mathtt{B}\)</span> are reset to zeros as per the fourth instruction.</p>
<p>The execution trace can now be updated to reflect the selector columns, as shown below.</p>
<div align="center"><b> Table 3: Execution Trace of the four instruction SM with Auxiliary columns  </b></div>

<div class="arithmatex">\[
\begin{aligned}
\begin{array}{|l|c|}
\hline
\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ } \bf{Instructions }\\ \hline
\texttt{ } \mathtt{\$\{getAFreeInput()\} =&gt; A} \\\hline
\texttt{ } \mathtt{3 =&gt; B} \qquad\qquad\qquad\qquad\quad\\\hline
\texttt{ } \mathtt{:ADD } \qquad\qquad\qquad\quad\quad\quad\text{ }\text{ }\\\hline
\texttt{ } \mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ }\\\hline
\end{array}
\hspace{0.1cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline 
 \texttt{FREE} &amp; \texttt{CONST}&amp; \texttt{setB}&amp; \mathtt{setA}&amp; \texttt{inFREE}&amp; \mathtt{inB} &amp; \mathtt{inA} \\ \hline 
 \texttt{7} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\texttt{0} &amp; \texttt{3} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
 \texttt{0} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} \\ \hline
  \texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\end{array}
\hspace{0.1cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{A} &amp; \mathtt{A'} &amp; \mathtt{B} &amp; \mathtt{B'}\\\hline
\mathtt{0} &amp; \mathtt{7} &amp; \mathtt{0} &amp; \mathtt{0}\\\hline
\mathtt{7} &amp; \mathtt{7} &amp; \mathtt{0} &amp; \mathtt{3}\\\hline
\mathtt{7} &amp; \mathtt{10} &amp; \mathtt{3} &amp; \mathtt{3}\\\hline
\mathtt{10} &amp; \mathtt{0} &amp; \mathtt{3} &amp; \mathtt{0}\\\hline
\end{array}
\end{aligned}
\]</div>
<p><strong>Remarks</strong>: </p>
<p>(a) The <span class="arithmatex">\(\texttt{CONST}\)</span> column stores the constants of the computation. It should however, not be mistaken for a constant polynomial. The term 'constant' refers to the fact that the column contains constants of the computations.</p>
<p>(b) It shall be seen later, in our implementation of a state machine with jumps, that <span class="arithmatex">\(\texttt{CONST}\)</span> is in fact a committed polynomial rather than a constant polynomial.</p>
<p>(c) All the operations in the constraints are carried out <span class="arithmatex">\(\mathtt{\ modulo }\)</span> the order <span class="arithmatex">\(p\)</span> of the prime field. The so-called <em>Goldilocks-like Field</em>, with <span class="arithmatex">\(p = 2^{64} − 2^{32} +1\)</span>, is mainly used where 64-bit numbers suffice (see <a href="https://github.com/mir-protocol/plonky2/blob/main/plonky2/plonky2.pdf">Plonky2</a>). Otherwise, the <a href="https://iden3-docs.readthedocs.io/en/latest/iden3_repos/research/publications/zkproof-standards-workshop-2/baby-jubjub/baby-jubjub.html">BN128 field</a> is deployed.</p>
<p>In order to match the type of commitment scheme used in the zkEVM, these arithmetic constraints must first be expressed as polynomial identities, which are in turn compiled with PILCOM.</p>
<h3 id="a-deeper-context-for-the-executor">A Deeper Context For The Executor</h3>
<p>Up to this stage, we have only mentioned that the SM executor reads instructions in a program written in zkASM, and it may take some <em>free</em> inputs in order to produce an execution trace. There is however a lot more detail that goes into this process.</p>
<p>For example, the executor does not really read the zkASM program as is. But rather, the zkASM program (which we name here, <span class="arithmatex">\(\texttt{program.zkasm}\)</span>), is first compiled with a tool called <span class="arithmatex">\(\bf{zkasmcom}\)</span>, into a JSON file (call the JSON file, <span class="arithmatex">\(\texttt{program.json}\)</span>).</p>
<p>Also, the <em>free</em> inputs may come in the form of another JSON file, let's name it <span class="arithmatex">\(\texttt{input.json}\)</span>. In addition, the executor can read information in databases and receive relevant input such as the <span class="arithmatex">\(\texttt{PIL.json}\)</span>. (As was seen in the case of the mFibonacci SM).</p>
<p>See Figure below for an concise description of what the executor does.</p>
<p><img alt="Figure 5: SM Executor in a broader context" src="../figures/sm-exec-broader-contxt.png" /></p>
<div align="center"><b> Figure 5: SM Executor within a deeper context </b></div>

<p>Although the execution trace is composed of the evaluations of the committed polynomials and the evaluations of the constant polynomials, the two evaluations do not happen simultaneously. </p>
<p>Instead, the constant polynomials are preprocessed only once, because they do not change and are specific for a particular state machine. </p>
<p>The committed polynomials, on the other hand, can vary. And are therefore only processed <em>as and when</em> their corresponding verifiable proof is required.</p>
<h3 id="polynomial-identities">Polynomial Identities</h3>
<p>For verification purposes, the execution trace need to be interpolated into polynomial identities.</p>
<p>The general theory on interpolation of polynomials involves technical terms such as; Lagrange's interpolation, roots of of unity and Fast Fourier Transforms. However, these concepts are not prerequisites because the way we construct the execution trace, makes sure the polynomial identities follow readily from the arithmetic constraints.</p>
<p>In the above example of a zkASM program with four instructions, we can use the fourth-roots of unity <span class="arithmatex">\(\mathcal{H} = \{ 1 = \omega^4, \omega, \omega^2, \omega^3 \} \subset \mathbb{F}_p\)</span>  to interpolate, such that the columns,
$$
\mathtt{ A, inA, setA, B, inB, setB, FREE, inFREE, CONST }
$$
correspond to polynomials in <span class="arithmatex">\(\texttt{x}\)</span> , where <span class="arithmatex">\(\mathtt{x = \omega^i}\)</span>, written (without changing symbols) as,
$$
\mathtt{ A(x), inA(x), setA(x), B(x), inB(x), setB(x), FREE(x), inFREE(x), CONST(x)}.
$$
That is, according to the execution trace in Table 3 above, these polynomials are equivalent to the column-arrays, as follows,
$$
\mathtt{A = [0,7,7,10]}\text{ } \iff\text{ } \mathtt{ A(x) = A(\omega^i) = A[i]}\qquad\quad\qquad\qquad\qquad\text{ } \
$$</p>
<div class="arithmatex">\[
\mathtt{B = [0,0,3,3] }\text{ } \iff\text{ } \mathtt{ B(x) = B(\omega^i) = B[i]}\qquad\qquad\qquad\qquad\qquad\text{}\text{ } \\
\]</div>
<div class="arithmatex">\[
\mathtt{inA = [0,0,1,1]\text{ } \iff\text{ } \mathtt{ inA(x) = inA(\omega^i) = inA[i]}}\qquad\qquad\quad\quad\text{}\text{} \\
\]</div>
<div class="arithmatex">\[
\mathtt{inB = [0,0,1,0]}\text{ } \iff\text{ } \mathtt{inB(x) = inB(\omega^i) = inB[i]}\qquad\qquad\quad\quad\text{}\text{ } \\
\]</div>
<div class="arithmatex">\[
\mathtt{setA = [1,0,1,1]\text{ } \iff\text{ } \mathtt{ setA(x) = setA(\omega^i) = setA[i]}}\qquad\quad\quad\text{}\text{} \\
\]</div>
<div class="arithmatex">\[
\mathtt{setB = [0,1,0,1] }\text{ } \iff\text{ } \mathtt{setB(x) = setB(\omega^i) = setB[i]}\qquad\quad\quad\text{}\text{ } \\
\]</div>
<div class="arithmatex">\[
\mathtt{FREE = [7,0,0,0]}\text{ } \iff\text{ } \mathtt{FREE(x) =  FREE(\omega^i) = FREE[i]}\qquad\quad\quad\text{}\text{ } \\
\]</div>
<div class="arithmatex">\[
\mathtt{CONST = [1,0,0,0]}\text{ } \iff\text{ } \mathtt{CONST(x) = CONST(\omega^i) = CONST[i]}\quad\quad\text{}\text{ } \\
\]</div>
<div class="arithmatex">\[
\mathtt{inFREE = [1,0,0,0] } \text{ }\text{ } \iff\text{ } \ \mathtt{inFREE(x) = inFREE(\omega^i) = inFREE[i]}
\]</div>
<p>The arithmetic constraints seen above as <span class="arithmatex">\(\bf{Eqn\ 1(a)}\)</span> and <span class="arithmatex">\(\bf{1(b)}\)</span>, are easily written as polynomial identities, as follows,
$$
\mathtt{A(x\omega) - \big(A(x) + setA(x) \cdot \big( op(x) - A(x) \big) \big) = 0} \
$$</p>
<div class="arithmatex">\[
\mathtt{B(x\omega) - \big( B(x) + setB(x) \cdot \big(  op(x) - B(x) \big) \big) = 0} \\
\]</div>
<p>where</p>
<div class="arithmatex">\[
\mathtt{op(x) = inA(x) \cdot A(x) + inB(x) \cdot B(x) + inFREE(x) \cdot FREE(x) + CONST(x)}.\\
\]</div>
<p>As far as boundary constraints are concerned, we can, for instance,</p>
<ul>
<li>
<p>make both the free input and the last registry value of <span class="arithmatex">\(\mathtt{A}\)</span> public,</p>
</li>
<li>
<p>create public 'variables'; <span class="arithmatex">\(\texttt{input}\)</span> and <span class="arithmatex">\(\texttt{output}\)</span>,</p>
</li>
<li>
<p>set boundary constraints,
  $$
  \mathtt{L1(x) \cdot \big(FREE(\omega^0) - input\big) = 0} \
  \mathtt{L2(x) \cdot \big(A(\omega^{3}) - output\big) = 0}\quad \
  $$
  where <span class="arithmatex">\(\mathtt{L1(x)}\)</span> and <span class="arithmatex">\(\mathtt{L2(x)}\)</span> are precomputed constant polynomials. In fact, <span class="arithmatex">\(\mathtt{L1(x) = [1,0,0,0]}\)</span> and  <span class="arithmatex">\(\mathtt{L2(x) = [0,0,0,1]}\)</span>. </p>
</li>
</ul>
<p>In the big scheme of things, these are Lagrange polynomials emanating from the interpolation.</p>
<p>Verification relies on the fact that: These polynomial identities, including the boundary constraints, hold true <em>if, and only if</em> the execution trace is correct and faithful to the instructions in the zkASM program.</p>
<p>The PIL description of the SM executor, reading instructions from the zkASM program with four instructions, is depicted in the Figure below.</p>
<p><img alt="Figure 6: The PIL description for the 4-instruction program" src="../figures/pil-4instrct-prog.png" /></p>
<div align="center"><b> Figure 6: The PIL description for the 4-instruction program  </b></div>

<h3 id="dealing-with-negative-numbers">Dealing With Negative Numbers</h3>
<p>In this subsection we make a few remarks on how to handle negative numbers. </p>
<p>Recall that all values of the execution trace belong to a field <span class="arithmatex">\(\mathbb{F}_p\)</span> where <span class="arithmatex">\(p=2^{64} −2^{32} +1\)</span>. Since, for all <span class="arithmatex">\(\mathtt{x \in \mathbb{F}_p }\)</span>, 
$$
\mathtt{(p-x) + x \equiv p \texttt{ modulo } p}
$$
and  <span class="arithmatex">\(\mathtt{p \equiv 0 \texttt{ modulo } p}\)</span>, it follows that <span class="arithmatex">\(\mathtt{-x \equiv p-x \texttt{ modulo } p}\)</span>. Therefore, any negative number <span class="arithmatex">\(\mathtt{-a}\)</span> is interpreted as <span class="arithmatex">\(\mathtt{p − a}\)</span>.</p>
<p>We consider a zkASM program with four instructions as before, except that it now moves a negative constant into registry <span class="arithmatex">\(\mathtt{B}\)</span>. The execution trace with free input <span class="arithmatex">\(\mathtt{7}\)</span> is as a follows,</p>
<div align="center"><b> Table 4: How to handle an instruction with a negative number </b></div>

<div class="arithmatex">\[
\begin{aligned}
\begin{array}{|l|c|}
\hline
\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ } \bf{Instructions }\\ \hline
\texttt{ } \mathtt{\$\{getAFreeInput()\} =&gt; A} \\\hline
\texttt{ } \mathtt{-3 =&gt; B} \qquad\qquad\qquad\qquad\quad\\\hline
\texttt{ } \mathtt{:ADD } \qquad\qquad\qquad\quad\quad\quad\text{ }\text{ }\\\hline
\texttt{ } \mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ }\\\hline
\end{array}
\hspace{0.1cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline 
 \texttt{FREE} &amp; \texttt{CONST}&amp; \texttt{setB}&amp; \mathtt{setA}&amp; \texttt{inFREE}&amp; \mathtt{inB} &amp; \mathtt{inA} \\ \hline 
\texttt{7} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\texttt{0} &amp; \texttt{p-3} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\texttt{0} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} \\ \hline
\texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\end{array}
\hspace{0.1cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{A} &amp; \mathtt{A'} &amp; \mathtt{B} &amp; \mathtt{B'}\\\hline
\mathtt{0} &amp; \mathtt{7} &amp; \mathtt{0} &amp; \mathtt{0}\\\hline
\mathtt{7} &amp; \mathtt{7} &amp; \mathtt{0} &amp; \mathtt{p-3}\\\hline
\mathtt{7} &amp; \mathtt{4} &amp; \mathtt{p-3} &amp; \mathtt{p-3}\\\hline
\mathtt{4} &amp; \mathtt{0} &amp; \mathtt{p-3} &amp; \mathtt{0}\\\hline
\end{array}
\end{aligned}
\]</div>
<h2 id="using-conditional-jumps">Using Conditional Jumps</h2>
<p>The FFTs are most efficient for polynomials of degree <span class="arithmatex">\(\mathtt{T + 1 = 2^N}\)</span>. This causes descrepancies when the program being executed has fewer instructions than an appropriate power of <span class="arithmatex">\(2\)</span>.</p>
<p>Consider the following program with five (5) instructions, and its corresponding execution trace:</p>
<div align="center"><b> Table 5: Execution Trace of the SM executing the 5-instruction program  </b></div>

<div class="arithmatex">\[
\begin{aligned}
\begin{array}{|l|c|}
\hline
\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ } \bf{Instructions }\\ \hline
\texttt{ } \mathtt{\$\{getAFreeInput()\} =&gt; A} \\\hline
\texttt{ } \mathtt{3 =&gt; B} \qquad\qquad\qquad\qquad\quad\\\hline
\texttt{ } \mathtt{:ADD } \qquad\qquad\qquad\quad\quad\quad\text{ }\text{ }\\\hline
\texttt{ } \mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ }\\\hline
\texttt{ } \mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ }\\\hline
\end{array}
\hspace{0.1cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline 
 \texttt{FREE} &amp; \texttt{CONST}&amp; \texttt{setB}&amp; \mathtt{setA}&amp; \texttt{inFREE}&amp; \mathtt{inB} &amp; \mathtt{inA} \\ \hline 
\texttt{7} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\texttt{0} &amp; \texttt{3} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\texttt{0} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} \\ \hline
\texttt{0} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} \\ \hline  
\texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\end{array}
\hspace{0.1cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{A} &amp; \mathtt{A'} &amp; \mathtt{B} &amp; \mathtt{B'}\\\hline
\mathtt{0} &amp; \mathtt{7} &amp; \mathtt{0} &amp; \mathtt{0}\\\hline
\mathtt{7} &amp; \mathtt{7} &amp; \mathtt{0} &amp; \mathtt{3}\\\hline
\mathtt{7} &amp; \mathtt{10} &amp; \mathtt{3} &amp; \mathtt{3}\\\hline
\mathtt{10} &amp; \mathtt{13} &amp; \mathtt{3} &amp; \mathtt{3}\\\hline
\mathtt{13} &amp; \mathtt{0} &amp; \mathtt{3} &amp; \mathtt{0}\\\hline
\end{array}
\end{aligned}
\]</div>
<p>The question is: How (or when) to end the program when the trace has size <span class="arithmatex">\(\mathtt{5}\)</span> and the polynomials have <span class="arithmatex">\(\mathtt{8}\)</span> evaluations?</p>
<h3 id="naive-way-to-end-the-program">Naïve Way To End The Program</h3>
<p>A simple fix could be: Repeating the "<span class="arithmatex">\(\texttt{:END}\)</span>" instruction in order to fill the execution trace up to the eighth row. But, for the sake of preserving the cyclicity of the state machine, the last instruction must ensure that the next values of registries revert back to their initial values.</p>
<div align="center"><b> Table 6: Execution Trace of the 5-instruction SM with a repeated ":END" instruction  </b></div>

<div class="arithmatex">\[
\begin{aligned}
\begin{array}{|l|c|}
\hline
\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ }\texttt{ } \bf{Instructions }\\ \hline
\texttt{ } \mathtt{\$\{getAFreeInput()\} =&gt; A} \\\hline
\texttt{ } \mathtt{3 =&gt; B} \qquad\qquad\qquad\qquad\quad\\\hline
\texttt{ } \mathtt{:ADD } \qquad\qquad\qquad\quad\quad\quad\text{ }\text{ }\\\hline
\texttt{ } \mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ }\\\hline
\texttt{ } \mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ }\\\hline
\texttt{ } \mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ }\\\hline
\texttt{ } \mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ }\\\hline
\texttt{ } \mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ }\\\hline
\end{array}
\hspace{0.1cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline 
 \texttt{FREE} &amp; \texttt{CONST}&amp; \texttt{setB}&amp; \mathtt{setA}&amp; \texttt{inFREE}&amp; \mathtt{inB} &amp; \mathtt{inA} \\ \hline 
\texttt{7} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\texttt{0} &amp; \texttt{3} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\texttt{0} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} \\ \hline
\texttt{0} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} \\ \hline  
\texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\texttt{0} &amp; \texttt{0} &amp; \texttt{1} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\ \hline
\end{array}
\hspace{0.1cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{A} &amp; \mathtt{A'} &amp; \mathtt{B} &amp; \mathtt{B'}\\\hline
\mathtt{0} &amp; \mathtt{7} &amp; \mathtt{0} &amp; \mathtt{0}\\\hline
\mathtt{7} &amp; \mathtt{7} &amp; \mathtt{0} &amp; \mathtt{3}\\\hline
\mathtt{7} &amp; \mathtt{10} &amp; \mathtt{3} &amp; \mathtt{3}\\\hline
\mathtt{10} &amp; \mathtt{13} &amp; \mathtt{3} &amp; \mathtt{3}\\\hline
\mathtt{13} &amp; \mathtt{0} &amp; \mathtt{3} &amp; \mathtt{0}\\\hline
\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0}\\\hline
\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0}\\\hline
\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0}\\\hline
\end{array}
\end{aligned}
\]</div>
<p>Note that, since there are no restrictions placed on the next values of <span class="arithmatex">\(\mathtt{A'}\)</span> and <span class="arithmatex">\(\mathtt{B'}\)</span>, we can set these to any values. In the above case, both <span class="arithmatex">\(\mathtt{A'}\)</span> and <span class="arithmatex">\(\mathtt{B'}\)</span> are set to zeros.</p>
<h3 id="conditional-jumps-examples">Conditional Jumps Examples</h3>
<p>We now add to the zkASM program, the instruction "<span class="arithmatex">\(\text{jump to a particular address if ... }\)</span>", denoted by <span class="arithmatex">\(\mathtt{JMPZ(addr)}\)</span>. Which means the executor must jump to the specified position in the program <em>on condition</em> that the preceding operation, denoted by <span class="arithmatex">\(\texttt{op}\)</span>, is zero.</p>
<p>Since this instruction needs to specify the destination of the jump, we need to add the line at which each instruction is placed in the program. This is shown in the table below.</p>
<div align="center"><b> Table 7: The 5-instruction program with auxiliary columns  </b></div>

<div class="arithmatex">\[
\begin{aligned}
\begin{array}{|l|c|}
\hline 
\texttt{ line } &amp; \bf{Instructions } \text{ }\text{ }\text{ }\text{ } \\ \hline
\quad\texttt{ 0 } &amp; \text{ }\mathtt{\$\{getAFreeInput()\} =&gt; A} \text{ }\\ \hline
\quad\texttt{ 1 } &amp; \text{ }\mathtt{-3 =&gt; B} \qquad\qquad\qquad\quad\quad \\ \hline
\quad\texttt{ 2 } &amp; \text{ }\mathtt{:ADD } \qquad\qquad\qquad\quad\quad\quad\text{ }\text{ } \\ \hline
\quad\texttt{ 3 } &amp; \text{ }\mathtt{A : JMPZ(5) } \quad\qquad\quad\quad\quad\text{ }\text{ } \\ \hline
\quad\texttt{ 4 } &amp; \text{ }\mathtt{:ADD } \qquad\qquad\qquad\quad\quad\quad\text{ }\text{ } \\ \hline
\quad\texttt{ 5 } &amp; \text{ }\mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ } \\ \hline 
\end{array}
\end{aligned}
\]</div>
<p>With regards to the instruction "<span class="arithmatex">\(\texttt{A:JMPZ(5)}\)</span>" in <span class="arithmatex">\(\texttt{line}\)</span> <span class="arithmatex">\(\texttt{3}\)</span> of the zkASM program,</p>
<p>(a) The <span class="arithmatex">\(\texttt{A}\)</span> registry, preceding the colon, means that <span class="arithmatex">\(\texttt{op}\)</span> is set to the value of <span class="arithmatex">\(\texttt{A}\)</span>.</p>
<p>(b) If <span class="arithmatex">\(\texttt{op = 0}\)</span>, the program jumps to $\texttt{line} $ <span class="arithmatex">\(\texttt{5}\)</span>.</p>
<p>(c) If <span class="arithmatex">\(\mathtt{op \not= 0}\)</span>,  the program continues sequentially with the instruction at $\texttt{line} $ <span class="arithmatex">\(\texttt{4}\)</span>.</p>
<h3 id="programs-with-conditional-jumps">Programs With Conditional Jumps</h3>
<p>Suppose the executor of our SM reads a zkASM program where one of its instructions requires a free input to be taken. The aim here is to observe how a variation in free inputs affects the length of the execution trace.</p>
<p>For the sake of brevity, we present execution traces with only five columns (i.e., we omit the columns corresponding to the selectors and setters).</p>
<p><strong>Example A: (Execution Trace with <span class="arithmatex">\(\mathtt{FREE = 7}\)</span>)</strong> </p>
<p>In this example, the free input is <span class="arithmatex">\(\mathtt{FREE = 7}\)</span>. Focusing on <span class="arithmatex">\(\texttt{line}\)</span> <span class="arithmatex">\(\texttt{3}\)</span>: Since in the previous operation, <span class="arithmatex">\(\mathtt{op=ADD}\)</span> and <span class="arithmatex">\(\mathtt{A = A + B = 4 \not= 0}\)</span>, and thus the condition for the <span class="arithmatex">\(\texttt{JMPZ}\)</span> is not satisfied. There's no jump. The execution continues sequentially to the instruction in <span class="arithmatex">\(\texttt{line}\)</span> <span class="arithmatex">\(\texttt{4}\)</span>. The resulting execution trace is therefore <span class="arithmatex">\(6\)</span> steps long.  </p>
<div class="arithmatex">\[
\begin{aligned}
\begin{array}{|l|c|}
\hline 
\texttt{ line } &amp; \bf{Instructions } \text{ }\text{ }\text{ }\text{ } \\ \hline
\quad\texttt{ 0 } &amp; \text{ }\mathtt{\$\{getAFreeInput()\} =&gt; A} \text{ }\\ \hline
\quad\texttt{ 1 } &amp; \text{ }\mathtt{-3 =&gt; B} \qquad\qquad\qquad\quad\quad \\ \hline
\quad\texttt{ 2 } &amp; \text{ }\mathtt{:ADD } \qquad\qquad\qquad\quad\quad\quad\text{ }\text{ } \\ \hline
\quad\texttt{ 3 } &amp; \text{ }\mathtt{A : JMPZ(5) } \quad\qquad\quad\quad\quad\text{ }\text{ } \\ \hline
\quad\texttt{ 4 } &amp; \text{ }\mathtt{:ADD } \qquad\qquad\qquad\quad\quad\quad\text{ }\text{ } \\ \hline
\quad\texttt{ 5 } &amp; \text{ }\mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ } \\ \hline 
\end{array}
\hspace{0.1cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{FREE} &amp; \mathtt{A} &amp; \mathtt{A'} &amp; \mathtt{B} &amp; \mathtt{B'\ }\\\hline
\quad\mathtt{7} &amp; \mathtt{0} &amp; \mathtt{7} &amp; \mathtt{0} &amp; \mathtt{0\ }\\\hline
\quad\mathtt{0} &amp;\mathtt{7} &amp; \mathtt{7} &amp; \mathtt{0} &amp; \mathtt{-3\ }\\\hline
\quad\mathtt{0} &amp; \mathtt{7} &amp; \mathtt{4} &amp; \mathtt{-3\ } &amp; \mathtt{-3\ }\\\hline
\quad\mathtt{0} &amp; \mathtt{4} &amp; \mathtt{4} &amp; \mathtt{-3\ } &amp; \mathtt{-3\ }\\\hline
\quad\mathtt{0} &amp; \mathtt{4} &amp; \mathtt{1} &amp; \mathtt{-3\ } &amp; \mathtt{-3\ }\\\hline
\quad\mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{0}\\\hline
\end{array}
\end{aligned}
\]</div>
<p><strong>Example B: (Execution Trace with <span class="arithmatex">\(\mathtt{FREE = 3}\)</span>)</strong> </p>
<p>In this case, the free input is <span class="arithmatex">\(\mathtt{FREE = 3}\)</span>. Again, focusing on <span class="arithmatex">\(\texttt{line}\)</span> <span class="arithmatex">\(\texttt{3}\)</span>: Since in the previous operation, <span class="arithmatex">\(\mathtt{op=ADD}\)</span> and <span class="arithmatex">\(\mathtt{A = A + B = 0}\)</span>, it means the condition for the <span class="arithmatex">\(\texttt{JMPZ}\)</span> is satisfied. Hence the executor jumps to <span class="arithmatex">\(\texttt{line}\)</span> <span class="arithmatex">\(\texttt{5}\)</span> as per instruction in <span class="arithmatex">\(\texttt{line}\)</span> <span class="arithmatex">\(\texttt{3}\)</span>. The execution trace is now only <span class="arithmatex">\(5\)</span> steps long.</p>
<div class="arithmatex">\[
\begin{aligned}
\begin{array}{|l|c|}
\hline 
\texttt{ line } &amp; \bf{Instructions } \text{ }\text{ }\text{ }\text{ } \\ \hline
\quad\texttt{ 0 } &amp; \text{ }\mathtt{\$\{getAFreeInput()\} =&gt; A} \text{ }\\ \hline
\quad\texttt{ 1 } &amp; \text{ }\mathtt{-3 =&gt; B} \qquad\qquad\qquad\quad\quad \\ \hline
\quad\texttt{ 2 } &amp; \text{ }\mathtt{:ADD } \qquad\qquad\qquad\quad\quad\quad\text{ }\text{ } \\ \hline
\quad\texttt{ 3 } &amp; \text{ }\mathtt{A : JMPZ(5) } \quad\qquad\quad\quad\quad\text{ }\text{ } \\ \hline
\quad\texttt{ 5 } &amp; \text{ }\mathtt{:END } \qquad\qquad\qquad\quad\qquad\text{}\text{ }\text{ } \\ \hline 
\end{array}
\hspace{0.1cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{FREE} &amp; \mathtt{A} &amp; \mathtt{A'} &amp; \mathtt{B} &amp; \mathtt{B'\ }\\\hline
\quad\mathtt{3} &amp; \mathtt{0} &amp; \mathtt{3} &amp; \mathtt{0} &amp; \mathtt{0\ }\\\hline
\quad\mathtt{0} &amp;\mathtt{3} &amp; \mathtt{3} &amp; \mathtt{0} &amp; \mathtt{-3\ }\\\hline
\quad\mathtt{0} &amp; \mathtt{3} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{-3\ }\\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{-3\ }\\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{0}\\\hline
\end{array}
\end{aligned}
\]</div>
<p>We observe that the inclusion of conditional jumps in the zkASM programs introduces dynamics to the executor's output. For example, the instructions in the zkASM program (in Example B) are not sequentially executed. This requires more agility in our proving system, more especially that our aim is to lighten the verifier's work.</p>
<h3 id="correctness-checks-for-state-machines-with-jumps">Correctness Checks For State Machines With Jumps</h3>
<p>The dynamism brought about by the inclusion of jumps in our zkASM programs means more checks need to be added, in order to prove correct behaviour of the state machine.</p>
<p>Since the instructions require the executor to perform varied operations, and these operations are not sequentially executed due to the presence of jumps, we need to do a few more checks;</p>
<ol>
<li><strong>Check Program Operations</strong>. </li>
</ol>
<p>Every operation being executed needs to be checked if it is the correct one. That is, if the instruction is an <span class="arithmatex">\(\texttt{ADD}\)</span>, then we must check that indeed an <span class="arithmatex">\(\texttt{ADD}\)</span> was performed and not a different operation.</p>
<ol>
<li><strong>Check Instructions’ Sequence</strong>.</li>
</ol>
<p>The sequence in which the operations are executed must tally with the instructions in the zkASM program, and not necessarily their usual chronological sequence of the lines of code. e.g., The lines of instructions executed in Example B above, are lines <span class="arithmatex">\(\texttt{ 0, 1, 2, 3, 5,}\)</span>  where <span class="arithmatex">\(\texttt{line}\)</span> <span class="arithmatex">\(\texttt{4}\)</span> was skipped.</p>
<p>Note that more complicated programs can be built, where for instance, the SM execution jumps to a previous line of code, and thus repeating execution of some instructions.</p>
<ol>
<li><strong>Correct program ending</strong>.</li>
</ol>
<p>How the program ends also needs to be managed. Due to the presence of jumps, the length of the execution trace is no longer constant for the same program if the free inputs are varied. </p>
<ol>
<li><strong>Publics Are Placed At Known Steps</strong>.</li>
</ol>
<p>We must ensure that all <span class="arithmatex">\(\texttt{publics}\)</span> (the inputs and the outputs) are in the known position. So, <span class="arithmatex">\(\texttt{publics}\)</span> should be placed at known steps. This ensures that the SM's PIL does not have to change with every execution. </p>
<p>For this reason, <span class="arithmatex">\(\texttt{publics}\)</span> are going to be placed in either the first positions of the polynomial or the last positions of the polynomial (these are specified positions in the arrays representing the columns of the trace).</p>
<ol>
<li><strong>Correct Program (ROM) Execution</strong>.</li>
</ol>
<p>Although the polynomial identities are there to monitor correct state transitions (checking that each instruction does what it is supposed to do), and also that the correct sequence of instructions is followed, one still needs to make sure the instruction being executed belongs to the program in the first place.  So, if for instance, the third instruction is being executed, is it really the third instruction of the right program or not.</p>
<p>One of the implications of a dynamic execution trace, due to the inclusion of jumps, is that some of the previously <em>constant</em> (or preprocessed) polynomials must now be <em>committed</em> polynomials.</p>
<p>If we are going to allow polynomials (i.e., columns in the execution trace) corresponding to the instructions to be committed, we need to be cautious that only instructions belonging to the right program are being executed. For this purpose, we are going to use a tool called <a href="https://eprint.iacr.org/2020/315.pdf"><span class="arithmatex">\(\mathbf{Plookup}\)</span></a>.</p>
<h3 id="checking-sequence-of-instructions">Checking Sequence Of Instructions</h3>
<p>In order to keep track of which line of the program is currently being executed, a new registry called "Program Counter" is added to the state machine.</p>
<p>We denote it by <span class="arithmatex">\(\texttt{zkPC}\)</span> because it is verified in a zero-knowledge manner.</p>
<p>The <span class="arithmatex">\(\texttt{zkPC}\)</span> is therefore a new column of the execution trace and it contains, at each clock, the line in the zkASM program of the instruction being executed.</p>
<p><img alt="Figure 7: A state machine with a Program Counter" src="../figures/state-machine-w-zkpc.png" /></p>
<div align="center"><b> Figure 7: A state machine with a Program Counter </b></div>

<p>In addition to the <span class="arithmatex">\(\texttt{JMPZ(addr)}\)</span>, an unconditional jump instruction <span class="arithmatex">\(\texttt{JMP(addr)}\)</span> is allowed in the zkASM program. </p>
<p>Unlike the <span class="arithmatex">\(\texttt{JMPZ(addr)}\)</span> instruction, when the state machine executes <span class="arithmatex">\(\texttt{JMP(addr)}\)</span>, it must jump to the line <span class="arithmatex">\(\texttt{addr}\)</span>, irrespective of what the value of <span class="arithmatex">\(\texttt{op}\)</span> is.</p>
<h4 id="the-program-counter-constraint-related-to-textttjmp">The Program Counter Constraint Related To <span class="arithmatex">\(\texttt{JMP}\)</span></h4>
<p>This is how the <span class="arithmatex">\(\texttt{JMP(addr)}\)</span> instruction is implemented: A new selector called <span class="arithmatex">\(\texttt{JMP}\)</span> is added, as a column to the execution trace. And, the Program Counter <span class="arithmatex">\(\texttt{zkPC}\)</span> now uses the following identity to keep track of the correct line of the assembly program to be executed next;
$$
\mathtt{zkPC' = (zkPC+1)+JMP \cdot \big(addr−(zkPC+1)\big)} \tag{Eqn 2*}
$$
<span class="arithmatex">\(\texttt{JMP}\)</span> therefore acts as a 'flag' where;</p>
<ul>
<li>if <span class="arithmatex">\(\texttt{JMP}\)</span> is not activated (i.e., if <span class="arithmatex">\(\texttt{JMP}\)</span> is <span class="arithmatex">\(\mathtt{0}\)</span>),</li>
</ul>
<div class="arithmatex">\[
\mathtt{zkPC' =  (zkPC+1)+ 0 \cdot \big(addr−(zkPC+1)\big) = zkPC+1}
\]</div>
<ul>
<li>otherwise,  if <span class="arithmatex">\(\texttt{JMP}\)</span> is activated (i.e., if <span class="arithmatex">\(\texttt{JMP}\)</span> is <span class="arithmatex">\(\mathtt{1}\)</span>),</li>
</ul>
<div class="arithmatex">\[
\mathtt{zkPC' = (zkPC+1)+ 1 \cdot \big(addr−(zkPC+1)\big) = addr}
\]</div>
<p>Note that execution continues with the next chronological line of instruction <span class="arithmatex">\(\texttt{zkPC+1}\)</span> when <span class="arithmatex">\(\texttt{JMP}\)</span> is <span class="arithmatex">\(\mathtt{0}\)</span>, but otherwise proceeds to execute the instruction in line number <span class="arithmatex">\(\texttt{addr}\)</span>.</p>
<h4 id="the-program-counter-constraint-related-to-textttjmpz">The Program Counter Constraint Related To <span class="arithmatex">\(\texttt{JMPZ}\)</span></h4>
<p>The <span class="arithmatex">\(\texttt{JMPZ(addr)}\)</span> similarly needs a selector to be added as an extra column to the execution trace, call it <span class="arithmatex">\(\texttt{JMPZ}\)</span>. Since the <span class="arithmatex">\(\texttt{JMPZ(addr)}\)</span> instruction is executed only on condition that <span class="arithmatex">\(\texttt{op}\)</span> is zero, we introduce a flag called <span class="arithmatex">\(\mathtt{isZero}\)</span>, such that; </p>
<p><span class="arithmatex">\(\mathtt{isZero = 1}\)</span> if <span class="arithmatex">\(\texttt{op = 0}\)</span>, and <span class="arithmatex">\(\mathtt{isZero = 0}\)</span> if <span class="arithmatex">\(\mathtt{op \not= 0}\)</span>. </p>
<p>This means <span class="arithmatex">\(\texttt{op}\)</span> and <span class="arithmatex">\(\mathtt{isZero}\)</span> satisfy the following constraint,</p>
<div class="arithmatex">\[
\mathtt{isZero \cdot op = 0} \tag{Eqn 3*}
\]</div>
<p>Note that <span class="arithmatex">\(\texttt{op}\)</span> is a field element, and every non-zero element of the prime field <span class="arithmatex">\(\mathbb{F}_p\)</span> has an inverse. That is, <span class="arithmatex">\(\texttt{op}^{-1}\)</span> exists <em>if and only if</em> <span class="arithmatex">\(\mathtt{op \not= 0}\)</span>. The following constraint together with <span class="arithmatex">\(\text{Eqn 3*}\)</span> can be used to check whether <span class="arithmatex">\(\texttt{op}\)</span> and <span class="arithmatex">\(\mathtt{isZero}\)</span> are as required,
$$
\mathtt{isZero\ := (1 − op \cdot op^{−1})} \tag{Eqn 4*}
$$</p>
<p>Since <span class="arithmatex">\(\mathtt{JMPZ = 1}\)</span> only if <span class="arithmatex">\(\texttt{JMPZ(addr)}\)</span> is the very instruction in the line currently being executed, and <span class="arithmatex">\(\mathtt{zkPC' = addr}\)</span>  only if  <span class="arithmatex">\(\mathtt{isZero = 1}\)</span>. </p>
<p>It follows that the factor  <span class="arithmatex">\((\mathtt{JMPZ \cdot isZero})\)</span> <span class="arithmatex">\(\mathtt{ = 1}\)</span>  only if both  <span class="arithmatex">\(\texttt{JMPZ}\)</span>  <span class="arithmatex">\(\mathtt{= 1}\)</span>  and <span class="arithmatex">\(\mathtt{isZero}\)</span> <span class="arithmatex">\(\mathtt{= 1}\)</span>  hold true.</p>
<p>Hence, the following constraint enforces the correct sequence of instructions when <span class="arithmatex">\(\texttt{JMPZ}\)</span> is executed;</p>
<div class="arithmatex">\[
\mathtt{zkPC' = (zkPC+1)+(JMPZ \cdot isZero) \cdot \big(addr−(zkPC+1)\big)} \tag{Eqn 5*}
\]</div>
<p>In order to ascertain correct execution of the <span class="arithmatex">\(\texttt{JMPZ(addr)}\)</span> instruction, it suffices to check the above three constraints; <span class="arithmatex">\(\text{Eqn 2*}\)</span>, <span class="arithmatex">\(\text{Eqn 2*}\)</span> and <span class="arithmatex">\(\text{Eqn 4*}\)</span>.</p>
<p>Note that <span class="arithmatex">\(\mathtt{op^{−1}}\)</span> is not part of any instruction. The evaluations of <span class="arithmatex">\(\mathtt{op^{−1}}\)</span> therefore have to be included in the execution trace as a committed polynomial, and thus enables checking the first identity, <span class="arithmatex">\(\text{Eqn 2*}\)</span>. </p>
<p>Most importantly, we rename the polynomial <span class="arithmatex">\(\mathtt{op^{−1}}\)</span> as <span class="arithmatex">\(\texttt{invOp}\)</span>.</p>
<h4 id="the-program-counter-constraint-related-to-textttjmp-and-textttjmpz">The Program Counter Constraint Related To <span class="arithmatex">\(\texttt{JMP}\)</span> And <span class="arithmatex">\(\texttt{JMPZ}\)</span></h4>
<p>All four constraints, <span class="arithmatex">\(\text{Eqn 0*}\)</span>, <span class="arithmatex">\(\text{Eqn 1*}\)</span>, <span class="arithmatex">\(\text{Eqn 2*}\)</span> and <span class="arithmatex">\(\text{Eqn 3*}\)</span> can be merged as follows;</p>
<div class="arithmatex">\[
\mathtt{isZero\ := (1 − op \cdot op^{−1})},\qquad\qquad\qquad\qquad\text{ }\qquad \\
\mathtt{isZero \cdot op = 0},\qquad\qquad\qquad\qquad\qquad\qquad\qquad\quad \\
\mathtt{doJMP := JPMZ \cdot isZero + JMP}, \qquad\qquad\qquad\qquad\quad \\
\mathtt{zkPC′ = (zkPC+1)+doJMP \cdot \big(addr−(zkPC+1)\big)} \tag{Eqn 6*}
\]</div>
<p>Define "<span class="arithmatex">\(\texttt{addr}\)</span>" as an intermediate polynomial, 
$$
\mathtt{ addr := offset}, \tag{Eqn 7*}
$$
where <span class="arithmatex">\(\texttt{offset}\)</span> is provided as part of the jump instructions, <span class="arithmatex">\(\texttt{JMPZ(addr)}\)</span> and <span class="arithmatex">\(\texttt{JMP(addr)}\)</span>.</p>
<p>We now have the following new columns in the execution trace,</p>
<div class="arithmatex">\[
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{zkPC} &amp; \mathtt{JMP} &amp; \mathtt{JMPZ} &amp; \mathtt{invOp} &amp; \mathtt{offset}\\\hline
\quad\mathtt{\dots\ } &amp; \mathtt{\dots } &amp; \mathtt{\dots} &amp; \mathtt{\dots} &amp; \mathtt{\dots}\\\hline
\quad\mathtt{\dots} &amp;\mathtt{\dots} &amp; \mathtt{\dots} &amp; \mathtt{\dots} &amp; \mathtt{\dots}\\\hline
\quad\mathtt{\dots} &amp; \mathtt{\dots} &amp; \mathtt{\dots} &amp; \mathtt{\dots} &amp; \mathtt{\dots}\\\hline
\quad\mathtt{\dots} &amp; \mathtt{\dots} &amp; \mathtt{\dots} &amp; \mathtt{\dots} &amp; \mathtt{\dots}\\
\end{array}
\]</div>
<p>With the intermediate definition in <span class="arithmatex">\(\text{Eqn 7*}\)</span> , we are preparing the path to expanding the <span class="arithmatex">\(\texttt{addr}\)</span> definition, for example, to include other sources (apart from instructions) from which to get the destination address in jumps.</p>
<h3 id="correct-program-ending-with-a-loop">Correct Program Ending With A Loop</h3>
<p>We have previously resorted to ending our program by repeating the "<span class="arithmatex">\(\texttt{:END}\)</span>" instruction. This was not the best solution. </p>
<p>To properly finish our programs, we need to ensure that the execution trace generated from the assembly is cyclic.</p>
<p>We therefore utilise a loop while the current <span class="arithmatex">\(\texttt{line}\)</span> is less than <span class="arithmatex">\(\mathtt{N-1}\)</span>, a step before the last step of the execution trace. That is, before jumping back to the start, with the <span class="arithmatex">\(\texttt{JMP(start)}\)</span> instruction, the current <span class="arithmatex">\(\texttt{line}\)</span> is checked with the function "<span class="arithmatex">\(\texttt{beforeLast()}\)</span>".</p>
<p>So, we query the executor for when the execution trace is at its last but one row, with the following line of code, 
$$
\mathtt{${beforeLast()}\ \ :JMPZ(finalWait)} ;
$$
See Figure 8 for the zkASM code.</p>
<p>The assembly program uses labels instead of explicit line numbers, hence conforming to how assembly programs are typically written. Labels are convenient because with them, the assembly compiler can take care of computing actual line numbers. For instance, as in Figure 8 below; <span class="arithmatex">\(\mathtt{start}\)</span> is line <span class="arithmatex">\(\mathtt{0}\)</span> and <span class="arithmatex">\(\mathtt{finalWait}\)</span> is line <span class="arithmatex">\(\mathtt{5}\)</span>.</p>
<p><img alt="Figure 8: Ending a Program with a loop" src="../figures/end-prog-w-loop.png" /></p>
<div align="center"><b> Figure 8: Ending a zkASM Program with a loop </b></div>

<h4 id="step-by-step-commentary-on-the-execution-trace">Step-by-step Commentary On The Execution Trace</h4>
<p>The intention here to give a step-by-step commentary on the execution trace for the Assembly code in Figure 8 above, for a free input equal to <span class="arithmatex">\(\mathtt{3}\)</span> and a trace size (interpolation size) equal to <span class="arithmatex">\(\texttt{N = 8}\)</span>.</p>
<p>We show the values corresponding to each <span class="arithmatex">\(\texttt{step}\)</span> of the execution trace, particularly for,</p>
<ul>
<li>The committed polynomials that form part of the instruction; <span class="arithmatex">\(\texttt{CONST}\)</span>, <span class="arithmatex">\(\texttt{offset}\)</span>, <span class="arithmatex">\(\texttt{JMP}\)</span>, <span class="arithmatex">\(\texttt{JMPZ}\)</span>, <span class="arithmatex">\(\texttt{setB}\)</span>, <span class="arithmatex">\(\texttt{setA}\)</span>, <span class="arithmatex">\(\texttt{inFREE}\)</span>,  <span class="arithmatex">\(\texttt{inB}\)</span>, <span class="arithmatex">\(\texttt{inA}\)</span>, <span class="arithmatex">\(\texttt{zkPC}\)</span> and <span class="arithmatex">\(\mathtt{zkPC'}\)</span>. </li>
<li>The committed polynomials that are only part of the trace; <span class="arithmatex">\(\texttt{FREE}\)</span>, <span class="arithmatex">\(\texttt{A}\)</span>, <span class="arithmatex">\(\mathtt{A'}\)</span>, <span class="arithmatex">\(\texttt{B}\)</span>, <span class="arithmatex">\(\mathtt{B'}\)</span> and  <span class="arithmatex">\(\texttt{invOp}\)</span>.</li>
<li>The intermediate polynomials <span class="arithmatex">\(\texttt{Im}\)</span>, which are just intermediate definitions; <span class="arithmatex">\(\texttt{op}\)</span>, <span class="arithmatex">\(\texttt{isZero}\)</span> and <span class="arithmatex">\(\texttt{doJMP}\)</span>.</li>
</ul>
<p><strong>Step 0</strong>:  "<span class="arithmatex">\(\mathtt{\${getAFreeInput()} =&gt; A}\)</span>"</p>
<p>Since the instruction here at <span class="arithmatex">\(\texttt{Step}\)</span> <span class="arithmatex">\(\mathtt{0}\)</span> (corresponding to <span class="arithmatex">\(\texttt{line}\)</span> <span class="arithmatex">\(\texttt{0}\)</span> of the Assembly code) requires a free input <span class="arithmatex">\(\mathtt{3}\)</span> to be taken and moved into the registry <span class="arithmatex">\(\mathtt{A}\)</span>, the values of the involved polynomials are therefore;
$$
 \mathtt{inFREE = 1},\ \mathtt{FREE = 3},\ \mathtt{setA = 1},\ \mathtt{A' = 3}\ \texttt{and}\ \mathtt{CONST = 0}.
$$
As a result,
$$
\mathtt{op\ =\ inA \cdot A\ +\ inB \cdot B\ +\ inFREE \cdot FREE\ +\ CONST = 0 \cdot A\ +\ 0 \cdot B\ +\ 1 \cdot 3\ +\ 0\ = 3}
$$
and <span class="arithmatex">\(\mathtt{invOp = 3^{-1}}\)</span>.</p>
<p>Regarding the Program Counter; First note that initially <span class="arithmatex">\(\mathtt{zkPC = 0}\)</span>. And, since <span class="arithmatex">\(\mathtt{op = 3}\)</span>  and <span class="arithmatex">\(\mathtt{invOp = 3^{-1}}\)</span>, then 
$$
\mathtt{isZero\ := (1 − op \cdot op^{−1}) = (1 − 3 \cdot 3^{−1}) = 0}.\qquad\qquad\qquad\qquad\text{ }\qquad \
$$
Also, since there are no jumps in the instruction, <span class="arithmatex">\(\mathtt{JMP = 0}\)</span> and <span class="arithmatex">\(\mathtt{JMPZ = 0}\)</span>, and therefore <span class="arithmatex">\(\mathtt{zkPC′ = zkPC + 1}\)</span>. </p>
<p>We use Eqn 4* to check whether <span class="arithmatex">\(\mathtt{zkPC′ = zkPC + 1 = 0+1 = 1}\)</span>. </p>
<p>First, note that, </p>
<div class="arithmatex">\[
\mathtt{doJMP := JPMZ \cdot isZero + JMP = 0 \cdot 0 + 0 = 0}. \qquad\qquad\qquad\qquad\qquad \\
\]</div>
<p>This means, according to Eqn 4*, </p>
<div class="arithmatex">\[
\mathtt{zkPC′ = (zkPC+1)+doJMP \cdot \big(addr−(zkPC+1)\big) = (0+1) + 0 \cdot \big( addr−(0+1) \big) = 0+1 = 1}.
\]</div>
<p><strong>Step 1</strong>:  "<span class="arithmatex">\(\mathtt{\mathtt{-3 =&gt; B}}\)</span>"</p>
<p>In this step, a constant  <span class="arithmatex">\(\mathtt{CONST = -3}\)</span>  is moved into the <span class="arithmatex">\(\texttt{B}\)</span> registry. Hence <span class="arithmatex">\(\mathtt{setB = 1}\)</span>, <span class="arithmatex">\(\mathtt{B' = -3}\)</span>, but <span class="arithmatex">\(\mathtt{inB = 0}\)</span>, <span class="arithmatex">\(\mathtt{inA = 0}\)</span> and <span class="arithmatex">\(\mathtt{inFREE = 0}\)</span>. This yields,
$$
\mathtt{op =\ inA \cdot A\ +\ inB \cdot B\ +\ inFREE \cdot FREE\ +\ CONST\ =\ 0 \cdot A\ +\ 0 \cdot B\ +\ 0 \cdot FREE\ + (-3)    = -3}
$$
and  <span class="arithmatex">\(\mathtt{invOp = (-3)^{-1}}\)</span>.</p>
<p>So, <span class="arithmatex">\(\mathtt{isZero\ := (1 − op \cdot op^{−1}) = \big(1 − (-3) \cdot (-3)^{−1}\big) = 0}\)</span>. </p>
<p>Again, the absence of jumps in the instruction means, <span class="arithmatex">\(\mathtt{JMP = 0}\)</span> and <span class="arithmatex">\(\mathtt{JMPZ = 0}\)</span>. And therefore <span class="arithmatex">\(\mathtt{zkPC′ = zkPC + 1}\)</span>.</p>
<p>Again, we use Eqn 4* to check whether <span class="arithmatex">\(\mathtt{zkPC′ = zkPC + 1 = 1+1 = 2}\)</span>. </p>
<p>Note that,
$$
\mathtt{doJMP := JPMZ \cdot isZero + JMP = 0 \cdot 0 + 0 = 0}. \qquad\qquad\qquad\qquad\qquad \
$$
Since <span class="arithmatex">\(\mathtt{zkPC = 1}\)</span>, the next value of the Program Counter (according to Eqn 4*) must therefore be, 
$$
\mathtt{zkPC′ = (zkPC+1)+doJMP \cdot \big(addr−(zkPC+1)\big) = (1+1) + 0 \cdot \big( addr−(1+1) \big) = 2}.
$$</p>
<p>Here is the execution trace thus far;</p>
<div align="center"><b> Table 8: The first 2 steps of the execution trace </b></div>

<div class="arithmatex">\[
\small
\begin{array}{|l|c|}
\hline 
\texttt{step} &amp; \bf{instructions} \\ \hline
\quad\texttt{0} &amp; \mathtt{${getAFreeInput()} =&gt; A}\text{ }\\ \hline
\quad\texttt{1} &amp; \mathtt{-3 =&gt; B}\text{ }\qquad\qquad\qquad\text{ }\text{ } \\ \hline
\end{array}
\hspace{0.02cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{CONST} &amp; \mathtt{offset} &amp; \mathtt{JMP} &amp; \mathtt{JMPZ} &amp; \mathtt{setB} &amp; \mathtt{setA} &amp; \mathtt{inFREE} &amp; \mathtt{inB} &amp; \mathtt{inA} &amp; \mathtt{zkPC} &amp; \mathtt{zkPC'} \\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1}\\\hline
\ \mathtt{-3} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{2}\\\hline
\end{array}
\hspace{0.02cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{op} &amp; \mathtt{isZero} &amp; \mathtt{doJMP} \\\hline
\text{ }\mathtt{3} &amp; \mathtt{0} &amp; \mathtt{0} \\\hline
\mathtt{-3} &amp;\mathtt{0} &amp; \mathtt{0}\\\hline
\end{array}
\hspace{0.02cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{FREE} &amp; \mathtt{A} &amp; \mathtt{A'} &amp; \mathtt{B} &amp; \mathtt{B'} &amp; \mathtt{invOp}\\\hline
\quad\mathtt{3} &amp; \mathtt{0} &amp; \mathtt{3} &amp; \mathtt{0} &amp; \mathtt{0\ } &amp; \mathtt{3^{-1}}\\\hline
\quad\mathtt{0} &amp;\mathtt{3} &amp; \mathtt{3} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{(-3)^{-1}}\\\hline
\end{array}
\]</div>
<p><strong>Step 2</strong>:  "<span class="arithmatex">\(\mathtt{ :ADD}\)</span>"</p>
<p>Here the sum of the registry values <span class="arithmatex">\(\mathtt{A = 3}\)</span> and <span class="arithmatex">\(\mathtt{B = -3}\)</span> is computed, and the result is moved into the registry <span class="arithmatex">\(\mathtt{A}\)</span>. That is, <span class="arithmatex">\(\mathtt{A' = 3 + (-3) = 0}\)</span>  and  <span class="arithmatex">\(\mathtt{setA = 1}\)</span>. Also, <span class="arithmatex">\(\mathtt{inA = 1}\)</span> , <span class="arithmatex">\(\mathtt{inB = 1}\)</span> and <span class="arithmatex">\(\mathtt{inFREE = 0}\)</span>.</p>
<p>These values yield the following value of <span class="arithmatex">\(\mathtt{op}\)</span>,
$$
\mathtt{op\ =\ inA \cdot A\ +\ inB \cdot B\ +\ inFREE \cdot FREE\ +\ CONST\ =\ 1 \cdot 3\ +\ 1 \cdot (-3)\ +\ 0 \cdot FREE\ +\ 0\  =\ 0}.
$$
So, <span class="arithmatex">\(\mathtt{invOp}\)</span> is set to a randomly chosen non-zero <span class="arithmatex">\(\mathtt{\alpha}\)</span> in <span class="arithmatex">\(\mathbb{F}_p\)</span> , used to pass the identities related to <span class="arithmatex">\(\texttt{isZero}\)</span>.</p>
<p>And, <span class="arithmatex">\(\mathtt{isZero\ := (1 − op \cdot invOp) = \big(1 − 0\cdot \alpha \big)\ =\ 1}\)</span>.</p>
<p>Note that there are no jumps in the instruction, so <span class="arithmatex">\(\mathtt{JMP = 0}\)</span> and <span class="arithmatex">\(\mathtt{JMPZ = 0}\)</span>. And therefore <span class="arithmatex">\(\mathtt{zkPC′ = zkPC + 1}\)</span>.</p>
<p>In order to verify that <span class="arithmatex">\(\mathtt{zkPC′ = zkPC + 1 = 2 + 1 = 3}\)</span>, we use the constraints given as Eqn 4* above.</p>
<p>Firstly, check <span class="arithmatex">\(\mathtt{doJMP}\)</span> as follows,
$$
\mathtt{doJMP\ :=\ JPMZ \cdot isZero + JMP\ = 0 \cdot 1\ +\ 0\ =\ 0}. \qquad\qquad\qquad\qquad\qquad \
$$
Then,
$$
\mathtt{zkPC′ = (zkPC+1)+doJMP \cdot \big(addr−(zkPC+1)\big) = (2+1)\ +\ 0 \cdot \big( addr - (2+1)\big)\ =\ 3}.
$$
The Program Counter therefore moves to the subsequent line of instruction. That is, the next instruction to be executed must the one in <span class="arithmatex">\(\texttt{line}\)</span> <span class="arithmatex">\(\texttt{3}\)</span> of the Assembly code.</p>
<p><strong>Step 3</strong>:  "<span class="arithmatex">\(\mathtt{ A \quad :JMPZ(finalWait)}\)</span>"</p>
<p>According this instruction, the executor has to jump on condition that <span class="arithmatex">\(\texttt{A}\)</span> is <span class="arithmatex">\(\mathtt{0}\)</span>, otherwise there is no jump. The polynomials immediately involved in this instruction are <span class="arithmatex">\(\mathtt{inA}\)</span> and <span class="arithmatex">\(\mathtt{JMPZ}\)</span>. Therefore, <span class="arithmatex">\(\mathtt{inA = 1}\)</span> and <span class="arithmatex">\(\mathtt{JMPZ = 1}\)</span>.</p>
<p>As mentioned above, the implicit address label "<span class="arithmatex">\(\mathtt{finalWait}\)</span>" is computed by the Assembly compiler, and in this example, that address is <span class="arithmatex">\(\mathtt{line}\)</span> <span class="arithmatex">\(\mathtt{5}\)</span>. That is, <span class="arithmatex">\(\mathtt{offset = 5}\)</span>. It follows that <span class="arithmatex">\(\mathtt{zkPC′ = 5}\)</span>.</p>
<p>Note that, <span class="arithmatex">\(\mathtt{inB = 0}\)</span> , <span class="arithmatex">\(\mathtt{inFREE = 0}\)</span> and <span class="arithmatex">\(\mathtt{CONST = 0}\)</span>. Therefore, 
$$
\mathtt{op\ =\ inA \cdot A\ +\ inB \cdot B\ +\ inFREE \cdot FREE\ +\ CONST\ =\ 1 \cdot 0\ +\ 0 \cdot (-3)\ +\ 0 \cdot FREE\ +\ 0\  =\ 0}.
$$
Consequently,  <span class="arithmatex">\(\mathtt{isZero\ := (1 − op \cdot invOp) = \big(1 − 0 \big)\ =\ 1}\)</span>.</p>
<p>Since there are no unconditional jumps, <span class="arithmatex">\(\mathtt{JMP = 0}\)</span>. We use Eqn 4* to check whether <span class="arithmatex">\(\mathtt{zkPC′ = 5}\)</span>. Note that,</p>
<div class="arithmatex">\[
\mathtt{doJMP := JPMZ \cdot isZero + JMP = 1 \cdot 1 + 0 = 1}. \qquad\qquad\qquad\qquad\qquad \\
\]</div>
<p>The next value of the Program Counter, according to Eqn 4*, is</p>
<div class="arithmatex">\[
\mathtt{zkPC′ = (zkPC+1)+doJMP \cdot \big(addr−(zkPC+1)\big)\ =\ (3+1)\ +\ 1 \cdot \big(5−(3+1)\big)\ =\ 4 + (5-4)\ =\ 5.}
\]</div>
<p><strong>Step 4</strong>:  "<span class="arithmatex">\(\mathtt{\{beforeLast()\}\quad:JMPZ(finalWait)}\)</span>"</p>
<p>The <span class="arithmatex">\(\texttt{beforeLast()}\)</span> function, which keeps track of the number of steps being executed, reads the current step-number as a free input. Since the execution trace is currently at step <span class="arithmatex">\(\mathtt{4}\)</span> and not <span class="arithmatex">\(\mathtt{6}\)</span>, then the executor returns a zero. And thus, <span class="arithmatex">\(\mathtt{inFREE = 1}\)</span> and <span class="arithmatex">\(\mathtt{JMPZ = 1}\)</span> but <span class="arithmatex">\(\mathtt{inA = 0}\)</span>, <span class="arithmatex">\(\mathtt{inB =0}\)</span>, <span class="arithmatex">\(\mathtt{FREE = 0}\)</span> and <span class="arithmatex">\(\mathtt{CONST = 0}\)</span>. Consequently, 
$$
\mathtt{op\ =\ inA \cdot A\ +\ inB \cdot B\ +\ inFREE \cdot FREE\ +\ CONST\ =\ 0 \cdot A\ +\ 0 \cdot B\ +\ 1 \cdot 0\ +\ 0\  =\ 0}.
$$
Therefore <span class="arithmatex">\(\mathtt{isZero \ := (1 − op \cdot invOp)\ = (1 − 0 \cdot \alpha) = 1}\)</span>. Hence according to <span class="arithmatex">\(\texttt{JMPZ(finalWait)}\)</span>, a jump is executed. This means the executor must jump to the <span class="arithmatex">\(\mathtt{offset = 5}\)</span> address, as computed by the Assembly compiler. It follows that <span class="arithmatex">\(\mathtt{zkPC′}\)</span> must be <span class="arithmatex">\(\mathtt{5}\)</span>.</p>
<p>Let us use Eqn 4* to check if indeed <span class="arithmatex">\(\mathtt{zkPC′ = 5}\)</span>. We first note that, there are no unconditional jumps, so <span class="arithmatex">\(\mathtt{JMP = 0}\)</span>. And, </p>
<div class="arithmatex">\[
\mathtt{doJMP := JPMZ \cdot isZero + JMP = 1 \cdot 1 + 0 = 1}. \qquad\qquad\qquad\qquad\qquad \\
\]</div>
<p>The next value of the Program Counter is given by,</p>
<div class="arithmatex">\[
\mathtt{zkPC′ = (zkPC+1)+doJMP \cdot \big(addr−(zkPC+1)\big)\ =\ (5+1)\ +\ 1 \cdot \big(5−(5+1)\big)\ =\ 6 + (5-6)\ =\ 5.}
\]</div>
<p>The execution trace is currently as follows,</p>
<div align="center"><b> Table 9: The first 5 steps of the execution trace </b></div>

<div class="arithmatex">\[
\small
\begin{array}{|l|c|}
\hline 
\texttt{step} &amp; \bf{instructions} \\ \hline
\quad\texttt{0} &amp; \mathtt{${getAFreeInput()} =&gt; A}\quad\qquad\qquad\\ \hline
\quad\texttt{1} &amp; \mathtt{-3 =&gt; B}\qquad\qquad\qquad\qquad\qquad\qquad\text{ }\text{ } \\ \hline
\quad\texttt{2} &amp; \mathtt{:ADD}\qquad\quad\qquad\qquad\qquad\qquad\qquad\ \\ \hline
\quad\texttt{3} &amp; \mathtt{A \qquad :JMPZ(finalWait)}\qquad\qquad \\ \hline
\quad\texttt{4} &amp; \mathtt{\{beforeLast()\}\quad:JMPZ(finalWait)} \\ \hline
\end{array}
\hspace{0.02cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{CONST} &amp; \mathtt{offset} &amp; \mathtt{JMP} &amp; \mathtt{JMPZ} &amp; \mathtt{setB} &amp; \mathtt{setA} &amp; \mathtt{inFREE} &amp; \mathtt{inB} &amp; \mathtt{inA} &amp; \mathtt{zkPC} &amp; \mathtt{zkPC'} \\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1}\\\hline
\ \mathtt{-3} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{2}\\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{1} &amp; \mathtt{2} &amp; \mathtt{3}\\\hline
\quad\mathtt{0} &amp; \mathtt{5} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{3} &amp; \mathtt{5}\\\hline
\quad\mathtt{0} &amp; \mathtt{5} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{5} &amp; \mathtt{5}\\\hline
\end{array}
\hspace{0.02cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{op} &amp; \mathtt{isZero} &amp; \mathtt{doJMP} \\\hline
\text{ }\mathtt{3} &amp; \mathtt{0} &amp; \mathtt{0} \\\hline
\mathtt{-3} &amp;\mathtt{0} &amp; \mathtt{0}\\\hline
\text{ }\mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} \\\hline
\text{ }\mathtt{0} &amp; \mathtt{1} &amp; \mathtt{1}\\\hline
\text{ }\mathtt{0} &amp; \mathtt{1} &amp; \mathtt{1} \\\hline
\end{array}
\hspace{0.02cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{FREE} &amp; \mathtt{A} &amp; \mathtt{A'} &amp; \mathtt{B} &amp; \mathtt{B'} &amp; \mathtt{invOp}\\\hline
\quad\mathtt{3} &amp; \mathtt{0} &amp; \mathtt{3} &amp; \mathtt{0} &amp; \mathtt{0\ } &amp; \mathtt{3^{-1}}\\\hline
\quad\mathtt{0} &amp;\mathtt{3} &amp; \mathtt{3} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{(-3)^{-1}}\\\hline
\quad\mathtt{0} &amp; \mathtt{3} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{-3\ } &amp; \mathtt{\alpha}\\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{-3\ } &amp; \mathtt{\alpha}\\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{-3} &amp; \mathtt{\alpha}\\\hline
\end{array}
\hspace{0.02cm}
\]</div>
<p><strong>Step 5</strong>:  "<span class="arithmatex">\(\mathtt{\{beforeLast()\}\quad:JMPZ(finalWait)}\)</span>"</p>
<p>As seen in Step 4, the <span class="arithmatex">\(\texttt{beforeLast()}\)</span> function checks if the execution trace is currently at Step 6. Since the current step is <span class="arithmatex">\(\mathtt{5}\)</span> and not <span class="arithmatex">\(\mathtt{6}\)</span>, the executor returns a zero.  </p>
<p>Similarly, <span class="arithmatex">\(\mathtt{inFREE = 1}\)</span> and <span class="arithmatex">\(\mathtt{JMPZ = 1}\)</span> but <span class="arithmatex">\(\mathtt{inA = 0}\)</span>, <span class="arithmatex">\(\mathtt{inB =0}\)</span>, <span class="arithmatex">\(\mathtt{FREE = 0}\)</span> and <span class="arithmatex">\(\mathtt{CONST = 0}\)</span>. As a result,
$$
\mathtt{op\ =\ inA \cdot A\ +\ inB \cdot B\ +\ inFREE \cdot FREE\ +\ CONST\ =\ 0 \cdot A\ +\ 0 \cdot B\ +\ 1 \cdot 0\ +\ 0\  =\ 0},
$$
which means  <span class="arithmatex">\(\mathtt{FREE = 0}\)</span> and <span class="arithmatex">\(\mathtt{isZero \ := (1 − op \cdot invOp)\ = (1 − 0 \cdot \alpha) = 1}\)</span>. So, again <span class="arithmatex">\(\texttt{JMPZ(finalWait)}\)</span> gets executed. </p>
<p>The absence of unconditional jumps means <span class="arithmatex">\(\mathtt{JMP = 0}\)</span>, while <span class="arithmatex">\(\mathtt{JMPZ = 1}\)</span>. Since <span class="arithmatex">\(\mathtt{offset = 5}\)</span>, the Program Counter, <span class="arithmatex">\(\mathtt{zkPC′}\)</span>, must in the next step be <span class="arithmatex">\(\mathtt{5}\)</span>.</p>
<p>We verify this by first checking 
$$
\mathtt{doJMP := JPMZ \cdot isZero + JMP = 1 \cdot 1 + 0 = 1}, \qquad\qquad\qquad\qquad\qquad \
$$
and use Eqn 4*,
$$
\mathtt{zkPC′ = (zkPC+1)+doJMP \cdot \big(addr−(zkPC+1)\big)\ =\ (5+1)\ +\ 1 \cdot \big(5−(5+1)\big)\ =\ 6 + (5-6)\ =\ 5.}
$$</p>
<p><strong>Step 6</strong>:  "<span class="arithmatex">\(\mathtt{\{beforeLast()\}\quad:JMPZ(finalWait)}\)</span>"</p>
<p>In this case, the current step is the last but one step. That is, the <span class="arithmatex">\(\texttt{beforeLast()}\)</span> function holds true, and hence the executor must return a <span class="arithmatex">\(\mathtt{1}\)</span>. So, <span class="arithmatex">\(\mathtt{inFREE = 1}\)</span> and <span class="arithmatex">\(\mathtt{JMPZ = 1}\)</span> while <span class="arithmatex">\(\mathtt{inA = 0}\)</span>, <span class="arithmatex">\(\mathtt{inB =0}\)</span> and <span class="arithmatex">\(\mathtt{CONST = 0}\)</span>. Then,
$$
\mathtt{op\ =\ inA \cdot A\ +\ inB \cdot B\ +\ inFREE \cdot FREE\ +\ CONST\ =\ 0 \cdot A\ +\ 0 \cdot B\ +\ 1 \cdot 1\ +\ 0\  =\ 1}.
$$
This means  <span class="arithmatex">\(\mathtt{FREE = 1}\)</span> and <span class="arithmatex">\(\mathtt{isZero \ := (1 − op \cdot invOp)\ = (1 − 1 \cdot 1) = 0}\)</span>. And, this time <span class="arithmatex">\(\texttt{JMPZ(finalWait)}\)</span> is not executed, implying the next Program Counter, <span class="arithmatex">\(\mathtt{zkPC′ = zkPC + 1}\)</span>. </p>
<p>Since there are no jumps in this step, <span class="arithmatex">\(\mathtt{JMP = 0}\)</span> and <span class="arithmatex">\(\mathtt{JMPZ = 0}\)</span>, yielding 
$$
\mathtt{doJMP := JPMZ \cdot isZero + JMP = 0 \cdot 1 + 0 = 0}, \
$$
and with a quick verification using Eqn 4*, we obtain
$$
\mathtt{zkPC′ = (zkPC+1)+doJMP \cdot \big(addr−(zkPC+1)\big)\ =\ (5+1)\ +\ 0 \cdot \big(addr −(5+1)\big)\ =\ 6.}
$$</p>
<p><strong>Step 7</strong>:  "<span class="arithmatex">\(\mathtt{0 =&gt; A,B\quad\ :JMP(start)}\)</span>"</p>
<p>The aim with this instruction is to complete the execution trace such that it is of the correct size (which is <span class="arithmatex">\(\mathtt{8}\)</span> in this example). </p>
<p>It ends the execution by setting <span class="arithmatex">\(\texttt{A}\)</span> and <span class="arithmatex">\(\texttt{B}\)</span> to zero, and jumps to <span class="arithmatex">\(\mathtt{start}\)</span>, which is line <span class="arithmatex">\(\mathtt{0}\)</span>. And thus, <span class="arithmatex">\(\mathtt{zkPC'}\)</span> must be <span class="arithmatex">\(\mathtt{0}\)</span>. Hence, <span class="arithmatex">\(\mathtt{setA = 1}\)</span>, <span class="arithmatex">\(\mathtt{setB = 1}\)</span> and <span class="arithmatex">\(\mathtt{JMP = 1}\)</span> but <span class="arithmatex">\(\mathtt{inFREE = 0}\)</span>, <span class="arithmatex">\(\mathtt{inA =0}\)</span>, <span class="arithmatex">\(\mathtt{inB =0}\)</span> and <span class="arithmatex">\(\mathtt{CONST = 0}\)</span>. Consequently, 
$$
\mathtt{op\ =\ inA \cdot A\ +\ inB \cdot B\ +\ inFREE \cdot FREE\ +\ CONST\ =\ 0 \cdot 0\ +\ 0 \cdot (-3)\ +\ 0 \cdot 1\ +\ 0\  =\ 0}.
$$
Therefore <span class="arithmatex">\(\mathtt{isZero \ := (1 − op \cdot invOp)\ = (1 − 0 \cdot \alpha) = 1}\)</span>. </p>
<p>There are no conditional jumps, so <span class="arithmatex">\(\mathtt{JMPZ = 0}\)</span>. Then, as a consequence of this, 
$$
\mathtt{doJMP := JPMZ \cdot isZero + JMP = 0 \cdot 1 + 1 = 1}. \
$$
The constraint in Eqn 4* verifies the next value of the Program Counter as follows,
$$
\mathtt{zkPC′ = (zkPC+1)+doJMP \cdot \big(addr−(zkPC+1)\big)\ =\ (6+1)\ +\ 1 \cdot \big(0 −(6+1)\big)\ =\ 0.}
$$</p>
<p>This instruction, as the last step the Assembly program, achieves two things; Firstly, the program ends correctly with the specified size of the execution trace. Secondly, resetting <span class="arithmatex">\(\texttt{A}\)</span>, <span class="arithmatex">\(\texttt{B}\)</span> and <span class="arithmatex">\(\texttt{zkPC}\)</span> to zero causes the execution trace to attain cyclicity.</p>
<p>See the complete execution trace below,</p>
<div align="center"><b> Table 10: The entire execution trace for an Assembly with JMP and JMPZ  </b></div>

<div class="arithmatex">\[
\small
\begin{array}{|l|c|}
\hline 
\texttt{step} &amp; \bf{instructions} \\ \hline
\quad\texttt{0} &amp; \mathtt{${getAFreeInput()} =&gt; A}\quad\qquad\qquad\\ \hline
\quad\texttt{1} &amp; \mathtt{-3 =&gt; B}\qquad\qquad\qquad\qquad\qquad\qquad\text{ }\text{ } \\ \hline
\quad\texttt{2} &amp; \mathtt{:ADD}\qquad\quad\qquad\qquad\qquad\qquad\qquad\ \\ \hline
\quad\texttt{3} &amp; \mathtt{A \qquad :JMPZ(finalWait)}\qquad\qquad \\ \hline
\quad\texttt{4} &amp; \mathtt{\{beforeLast()\}\quad:JMPZ(finalWait)} \\ \hline
\quad\texttt{5} &amp; \mathtt{\{beforeLast()\}\quad:JMPZ(finalWait)}\\ \hline
\quad\texttt{6} &amp; \mathtt{\{beforeLast()\}\quad:JMPZ(finalWait)}\\ \hline
\quad\texttt{7} &amp; \mathtt{0 =&gt; A,B \quad\qquad\ \ :JMP(start)}\qquad \\ \hline
\end{array}
\hspace{0.02cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{CONST} &amp; \mathtt{offset} &amp; \mathtt{JMP} &amp; \mathtt{JMPZ} &amp; \mathtt{setB} &amp; \mathtt{setA} &amp; \mathtt{inFREE} &amp; \mathtt{inB} &amp; \mathtt{inA} &amp; \mathtt{zkPC} &amp; \mathtt{zkPC'} \\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1}\\\hline
\ \mathtt{-3} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{2}\\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{1} &amp; \mathtt{2} &amp; \mathtt{3}\\\hline
\quad\mathtt{0} &amp; \mathtt{5} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{3} &amp; \mathtt{5}\\\hline
\quad\mathtt{0} &amp; \mathtt{5} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{5} &amp; \mathtt{5}\\\hline
\quad\mathtt{0} &amp; \mathtt{5} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{5} &amp; \mathtt{5}\\\hline
\quad\mathtt{0} &amp; \mathtt{5} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{5} &amp; \mathtt{6}\\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{1} &amp; \mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{6} &amp; \mathtt{0}\\\hline
\end{array}
\hspace{0.02cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{op} &amp; \mathtt{isZero} &amp; \mathtt{doJMP} \\\hline
\text{ }\mathtt{3} &amp; \mathtt{0} &amp; \mathtt{0} \\\hline
\mathtt{-3} &amp;\mathtt{0} &amp; \mathtt{0}\\\hline
\text{ }\mathtt{0} &amp; \mathtt{1} &amp; \mathtt{0} \\\hline
\text{ }\mathtt{0} &amp; \mathtt{1} &amp; \mathtt{1}\\\hline
\text{ }\mathtt{0} &amp; \mathtt{1} &amp; \mathtt{1} \\\hline
\text{ }\mathtt{0} &amp;\mathtt{1} &amp; \mathtt{1}\\\hline
\text{ }\mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} \\\hline
\text{ }\mathtt{0} &amp; \mathtt{1} &amp; \mathtt{1}\\\hline
\end{array}
\hspace{0.02cm}
\begin{array}{|l|c|c|c|c|c|c|c|}\hline
\mathtt{FREE} &amp; \mathtt{A} &amp; \mathtt{A'} &amp; \mathtt{B} &amp; \mathtt{B'} &amp; \mathtt{invOp}\\\hline
\quad\mathtt{3} &amp; \mathtt{0} &amp; \mathtt{3} &amp; \mathtt{0} &amp; \mathtt{0\ } &amp; \mathtt{3^{-1}}\\\hline
\quad\mathtt{0} &amp;\mathtt{3} &amp; \mathtt{3} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{(-3)^{-1}}\\\hline
\quad\mathtt{0} &amp; \mathtt{3} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{-3\ } &amp; \mathtt{\alpha}\\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{-3\ } &amp; \mathtt{\alpha}\\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{-3} &amp; \mathtt{\alpha}\\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{-3\ } &amp; \mathtt{\alpha}\\\hline
\quad\mathtt{1} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{-3\ } &amp; \mathtt{1}\\\hline
\quad\mathtt{0} &amp; \mathtt{0} &amp; \mathtt{0} &amp; \mathtt{-3\ } &amp; \mathtt{0} &amp; \mathtt{\alpha}\\\hline
\end{array}
\hspace{0.02cm}
\]</div>
<p>In conclusion, our Assembly program uses jumps to create a loop in its execution. That is, at the right point of the execution, when the registry values of interest have been attained, the executor retains these values until the execution trace is in the last but one row. This way, the result of the computations can be reflected in the last position of the registry <span class="arithmatex">\(\mathtt{A}\)</span>, in the last row of the execution trace, which is the output of the mFibonacci state machine.</p>
<p>Note that in cases where the jumps are such that <span class="arithmatex">\(\mathtt{offset}\)</span> is one of the previous addresses, the length of the execution trace can turn out to be much bigger than the final value of the Program Counter. i.e., <span class="arithmatex">\(\mathtt{zkPC \leq 2^N - 1}\)</span> where <span class="arithmatex">\(\mathtt{2^N -1}\)</span> is the degree of the state machine polynomials.  </p>
<h3 id="publics-placed-at-known-steps">Publics Placed at Known Steps</h3>
<p>Regarding the <span class="arithmatex">\(\texttt{publics}\)</span>, it is best to place these at specific and known steps. </p>
<p>Notice that, in the above example, the final loop added to Assembly program repeats the values of the registries <span class="arithmatex">\(\mathtt{A}\)</span> and <span class="arithmatex">\(\mathtt{B}\)</span> until they are reset to Step <span class="arithmatex">\(\mathtt{0}\)</span>.</p>
<p>So if, for example, the execution result or state machine output is the state of registry <span class="arithmatex">\(\mathtt{A}\)</span> at the end of all the instructions, we will find this value at <span class="arithmatex">\(\mathtt{A(N-1)}\)</span>.</p>
<p>This is important for verification purposes, because then, we need only add the proper boundary constraint in the PIL, referencing a specific step in the execution trace.   </p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../mFibonnaci-State-Machine-eg/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Multiplicative Fibonacci SM" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Multiplicative Fibonacci SM
            </div>
          </div>
        </a>
      
      
        
        <a href="../../zkProver/Overview/zkProver-Overview/" class="md-footer__link md-footer__link--next" aria-label="Next: zkProver Overview" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              zkProver Overview
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://t.me/polygonhermez" target="_blank" rel="noopener" title="t.me" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M248 8C111.033 8 0 119.033 0 256s111.033 248 248 248 248-111.033 248-248S384.967 8 248 8Zm114.952 168.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452 0 0 1 3.53 6.716 43.765 43.765 0 0 1 .417 9.769Z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/hermeznetwork/zkevmdoc" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://hermez.io/" target="_blank" rel="noopener" title="hermez.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M0 3.75C0 2.784.784 2 1.75 2h20.5c.966 0 1.75.784 1.75 1.75v16.5A1.75 1.75 0 0 1 22.25 22H1.75A1.75 1.75 0 0 1 0 20.25V3.75zm1.75-.25a.25.25 0 0 0-.25.25V5.5h4v-2H1.75zM7 3.5v2h4v-2H7zm5.5 0v2h10V3.75a.25.25 0 0 0-.25-.25H12.5zm10 3.5h-21v13.25c0 .138.112.25.25.25h20.5a.25.25 0 0 0 .25-.25V7z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.tracking"], "search": "../../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.d6c3db9e.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>